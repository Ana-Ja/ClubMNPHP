<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
	 <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=true"></script>
	 <script type="text/javascript" src="data:application/octet-stream;base64,InVzZSBzdHJpY3QiOwooZnVuY3Rpb24ocm9vdCwgZmFjdG9yeSkgewogIGlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykgewogICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgfQogIGVsc2UgaWYodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoWydqcXVlcnknLCAnZ29vZ2xlbWFwcyEnXSwgZmFjdG9yeSk7CiAgfQogIGVsc2UgewogICAgcm9vdC5HTWFwcyA9IGZhY3RvcnkoKTsKICB9CgoKfSh0aGlzLCBmdW5jdGlvbigpIHsKCi8qIQogKiBHTWFwcy5qcyB2MC40LjIxCiAqIGh0dHA6Ly9ocG5lby5naXRodWIuY29tL2dtYXBzLwogKgogKiBDb3B5cmlnaHQgMjAxNSwgR3VzdGF2byBMZW9uCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4KICovCgp2YXIgZXh0ZW5kX29iamVjdCA9IGZ1bmN0aW9uKG9iaiwgbmV3X29iaikgewogIHZhciBuYW1lOwoKICBpZiAob2JqID09PSBuZXdfb2JqKSB7CiAgICByZXR1cm4gb2JqOwogIH0KCiAgZm9yIChuYW1lIGluIG5ld19vYmopIHsKICAgIG9ialtuYW1lXSA9IG5ld19vYmpbbmFtZV07CiAgfQoKICByZXR1cm4gb2JqOwp9OwoKdmFyIHJlcGxhY2Vfb2JqZWN0ID0gZnVuY3Rpb24ob2JqLCByZXBsYWNlKSB7CiAgdmFyIG5hbWU7CgogIGlmIChvYmogPT09IHJlcGxhY2UpIHsKICAgIHJldHVybiBvYmo7CiAgfQoKICBmb3IgKG5hbWUgaW4gcmVwbGFjZSkgewogICAgaWYgKG9ialtuYW1lXSAhPSB1bmRlZmluZWQpIHsKICAgICAgb2JqW25hbWVdID0gcmVwbGFjZVtuYW1lXTsKICAgIH0KICB9CgogIHJldHVybiBvYmo7Cn07Cgp2YXIgYXJyYXlfbWFwID0gZnVuY3Rpb24oYXJyYXksIGNhbGxiYWNrKSB7CiAgdmFyIG9yaWdpbmFsX2NhbGxiYWNrX3BhcmFtcyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMiksCiAgICAgIGFycmF5X3JldHVybiA9IFtdLAogICAgICBhcnJheV9sZW5ndGggPSBhcnJheS5sZW5ndGgsCiAgICAgIGk7CgogIGlmIChBcnJheS5wcm90b3R5cGUubWFwICYmIGFycmF5Lm1hcCA9PT0gQXJyYXkucHJvdG90eXBlLm1hcCkgewogICAgYXJyYXlfcmV0dXJuID0gQXJyYXkucHJvdG90eXBlLm1hcC5jYWxsKGFycmF5LCBmdW5jdGlvbihpdGVtKSB7CiAgICAgIHZhciBjYWxsYmFja19wYXJhbXMgPSBvcmlnaW5hbF9jYWxsYmFja19wYXJhbXMuc2xpY2UoMCk7CiAgICAgIGNhbGxiYWNrX3BhcmFtcy5zcGxpY2UoMCwgMCwgaXRlbSk7CgogICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgY2FsbGJhY2tfcGFyYW1zKTsKICAgIH0pOwogIH0KICBlbHNlIHsKICAgIGZvciAoaSA9IDA7IGkgPCBhcnJheV9sZW5ndGg7IGkrKykgewogICAgICBjYWxsYmFja19wYXJhbXMgPSBvcmlnaW5hbF9jYWxsYmFja19wYXJhbXM7CiAgICAgIGNhbGxiYWNrX3BhcmFtcy5zcGxpY2UoMCwgMCwgYXJyYXlbaV0pOwogICAgICBhcnJheV9yZXR1cm4ucHVzaChjYWxsYmFjay5hcHBseSh0aGlzLCBjYWxsYmFja19wYXJhbXMpKTsKICAgIH0KICB9CgogIHJldHVybiBhcnJheV9yZXR1cm47Cn07Cgp2YXIgYXJyYXlfZmxhdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgdmFyIG5ld19hcnJheSA9IFtdLAogICAgICBpOwoKICBmb3IgKGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHsKICAgIG5ld19hcnJheSA9IG5ld19hcnJheS5jb25jYXQoYXJyYXlbaV0pOwogIH0KCiAgcmV0dXJuIG5ld19hcnJheTsKfTsKCnZhciBjb29yZHNUb0xhdExuZ3MgPSBmdW5jdGlvbihjb29yZHMsIHVzZUdlb0pTT04pIHsKICB2YXIgZmlyc3RfY29vcmQgPSBjb29yZHNbMF0sCiAgICAgIHNlY29uZF9jb29yZCA9IGNvb3Jkc1sxXTsKCiAgaWYgKHVzZUdlb0pTT04pIHsKICAgIGZpcnN0X2Nvb3JkID0gY29vcmRzWzFdOwogICAgc2Vjb25kX2Nvb3JkID0gY29vcmRzWzBdOwogIH0KCiAgcmV0dXJuIG5ldyBnb29nbGUubWFwcy5MYXRMbmcoZmlyc3RfY29vcmQsIHNlY29uZF9jb29yZCk7Cn07Cgp2YXIgYXJyYXlUb0xhdExuZyA9IGZ1bmN0aW9uKGNvb3JkcywgdXNlR2VvSlNPTikgewogIHZhciBpOwoKICBmb3IgKGkgPSAwOyBpIDwgY29vcmRzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAoIShjb29yZHNbaV0gaW5zdGFuY2VvZiBnb29nbGUubWFwcy5MYXRMbmcpKSB7CiAgICAgIGlmIChjb29yZHNbaV0ubGVuZ3RoID4gMCAmJiB0eXBlb2YoY29vcmRzW2ldWzBdKSA9PT0gIm9iamVjdCIpIHsKICAgICAgICBjb29yZHNbaV0gPSBhcnJheVRvTGF0TG5nKGNvb3Jkc1tpXSwgdXNlR2VvSlNPTik7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgY29vcmRzW2ldID0gY29vcmRzVG9MYXRMbmdzKGNvb3Jkc1tpXSwgdXNlR2VvSlNPTik7CiAgICAgIH0KICAgIH0KICB9CgogIHJldHVybiBjb29yZHM7Cn07Cgp2YXIgZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9IGZ1bmN0aW9uIChjbGFzc19uYW1lLCBjb250ZXh0KSB7CgogICAgdmFyIGVsZW1lbnQsCiAgICAgICAgX2NsYXNzID0gY2xhc3NfbmFtZS5yZXBsYWNlKCcuJywgJycpOwoKICAgIGlmICgnalF1ZXJ5JyBpbiB0aGlzICYmIGNvbnRleHQpIHsKICAgICAgICBlbGVtZW50ID0gJCgiLiIgKyBfY2xhc3MsIGNvbnRleHQpWzBdOwogICAgfSBlbHNlIHsKICAgICAgICBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShfY2xhc3MpWzBdOwogICAgfQogICAgcmV0dXJuIGVsZW1lbnQ7Cgp9OwoKdmFyIGdldEVsZW1lbnRCeUlkID0gZnVuY3Rpb24oaWQsIGNvbnRleHQpIHsKICB2YXIgZWxlbWVudCwKICBpZCA9IGlkLnJlcGxhY2UoJyMnLCAnJyk7CgogIGlmICgnalF1ZXJ5JyBpbiB3aW5kb3cgJiYgY29udGV4dCkgewogICAgZWxlbWVudCA9ICQoJyMnICsgaWQsIGNvbnRleHQpWzBdOwogIH0gZWxzZSB7CiAgICBlbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogIH07CgogIHJldHVybiBlbGVtZW50Owp9OwoKdmFyIGZpbmRBYnNvbHV0ZVBvc2l0aW9uID0gZnVuY3Rpb24ob2JqKSAgewogIHZhciBjdXJsZWZ0ID0gMCwKICAgICAgY3VydG9wID0gMDsKCiAgaWYgKG9iai5vZmZzZXRQYXJlbnQpIHsKICAgIGRvIHsKICAgICAgY3VybGVmdCArPSBvYmoub2Zmc2V0TGVmdDsKICAgICAgY3VydG9wICs9IG9iai5vZmZzZXRUb3A7CiAgICB9IHdoaWxlIChvYmogPSBvYmoub2Zmc2V0UGFyZW50KTsKICB9CgogIHJldHVybiBbY3VybGVmdCwgY3VydG9wXTsKfTsKCnZhciBHTWFwcyA9IChmdW5jdGlvbihnbG9iYWwpIHsKICAidXNlIHN0cmljdCI7CgogIGlmICghKHR5cGVvZiB3aW5kb3cuZ29vZ2xlID09PSAnb2JqZWN0JyAmJiB3aW5kb3cuZ29vZ2xlLm1hcHMpKSB7CiAgICBpZiAodHlwZW9mIHdpbmRvdy5jb25zb2xlID09PSAnb2JqZWN0JyAmJiB3aW5kb3cuY29uc29sZS5lcnJvcikgewogICAgICBjb25zb2xlLmVycm9yKCdHb29nbGUgTWFwcyBBUEkgaXMgcmVxdWlyZWQuIFBsZWFzZSByZWdpc3RlciB0aGUgZm9sbG93aW5nIEphdmFTY3JpcHQgbGlicmFyeSBodHRwczovL21hcHMuZ29vZ2xlYXBpcy5jb20vbWFwcy9hcGkvanMuJyk7CiAgICB9CgogICAgcmV0dXJuIGZ1bmN0aW9uKCkge307CiAgfQoKICB2YXIgZG9jID0gZG9jdW1lbnQ7CgogIHZhciBHTWFwcyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIGlmICghdGhpcykgcmV0dXJuIG5ldyBHTWFwcyhvcHRpb25zKTsKCiAgICBvcHRpb25zLnpvb20gPSBvcHRpb25zLnpvb20gfHwgMTU7CiAgICBvcHRpb25zLm1hcFR5cGUgPSBvcHRpb25zLm1hcFR5cGUgfHwgJ3JvYWRtYXAnOwoKICAgIHZhciB2YWx1ZU9yRGVmYXVsdCA9IGZ1bmN0aW9uKHZhbHVlLCBkZWZhdWx0VmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSB1bmRlZmluZWQgPyBkZWZhdWx0VmFsdWUgOiB2YWx1ZTsKICAgIH07CgogICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgIGksCiAgICAgICAgZXZlbnRzX3RoYXRfaGlkZV9jb250ZXh0X21lbnUgPSBbCiAgICAgICAgICAnYm91bmRzX2NoYW5nZWQnLCAnY2VudGVyX2NoYW5nZWQnLCAnY2xpY2snLCAnZGJsY2xpY2snLCAnZHJhZycsCiAgICAgICAgICAnZHJhZ2VuZCcsICdkcmFnc3RhcnQnLCAnaWRsZScsICdtYXB0eXBlaWRfY2hhbmdlZCcsICdwcm9qZWN0aW9uX2NoYW5nZWQnLAogICAgICAgICAgJ3Jlc2l6ZScsICd0aWxlc2xvYWRlZCcsICd6b29tX2NoYW5nZWQnCiAgICAgICAgXSwKICAgICAgICBldmVudHNfdGhhdF9kb2VzbnRfaGlkZV9jb250ZXh0X21lbnUgPSBbJ21vdXNlbW92ZScsICdtb3VzZW91dCcsICdtb3VzZW92ZXInXSwKICAgICAgICBvcHRpb25zX3RvX2JlX2RlbGV0ZWQgPSBbJ2VsJywgJ2xhdCcsICdsbmcnLCAnbWFwVHlwZScsICd3aWR0aCcsICdoZWlnaHQnLCAnbWFya2VyQ2x1c3RlcmVyJywgJ2VuYWJsZU5ld1N0eWxlJ10sCiAgICAgICAgaWRlbnRpZmllciA9IG9wdGlvbnMuZWwgfHwgb3B0aW9ucy5kaXYsCiAgICAgICAgbWFya2VyQ2x1c3RlcmVyRnVuY3Rpb24gPSBvcHRpb25zLm1hcmtlckNsdXN0ZXJlciwKICAgICAgICBtYXBUeXBlID0gZ29vZ2xlLm1hcHMuTWFwVHlwZUlkW29wdGlvbnMubWFwVHlwZS50b1VwcGVyQ2FzZSgpXSwKICAgICAgICBtYXBfY2VudGVyID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhvcHRpb25zLmxhdCwgb3B0aW9ucy5sbmcpLAogICAgICAgIHpvb21Db250cm9sID0gdmFsdWVPckRlZmF1bHQob3B0aW9ucy56b29tQ29udHJvbCwgdHJ1ZSksCiAgICAgICAgem9vbUNvbnRyb2xPcHQgPSBvcHRpb25zLnpvb21Db250cm9sT3B0IHx8IHsKICAgICAgICAgIHN0eWxlOiAnREVGQVVMVCcsCiAgICAgICAgICBwb3NpdGlvbjogJ1RPUF9MRUZUJwogICAgICAgIH0sCiAgICAgICAgem9vbUNvbnRyb2xTdHlsZSA9IHpvb21Db250cm9sT3B0LnN0eWxlIHx8ICdERUZBVUxUJywKICAgICAgICB6b29tQ29udHJvbFBvc2l0aW9uID0gem9vbUNvbnRyb2xPcHQucG9zaXRpb24gfHwgJ1RPUF9MRUZUJywKICAgICAgICBwYW5Db250cm9sID0gdmFsdWVPckRlZmF1bHQob3B0aW9ucy5wYW5Db250cm9sLCB0cnVlKSwKICAgICAgICBtYXBUeXBlQ29udHJvbCA9IHZhbHVlT3JEZWZhdWx0KG9wdGlvbnMubWFwVHlwZUNvbnRyb2wsIHRydWUpLAogICAgICAgIHNjYWxlQ29udHJvbCA9IHZhbHVlT3JEZWZhdWx0KG9wdGlvbnMuc2NhbGVDb250cm9sLCB0cnVlKSwKICAgICAgICBzdHJlZXRWaWV3Q29udHJvbCA9IHZhbHVlT3JEZWZhdWx0KG9wdGlvbnMuc3RyZWV0Vmlld0NvbnRyb2wsIHRydWUpLAogICAgICAgIG92ZXJ2aWV3TWFwQ29udHJvbCA9IHZhbHVlT3JEZWZhdWx0KG92ZXJ2aWV3TWFwQ29udHJvbCwgdHJ1ZSksCiAgICAgICAgbWFwX29wdGlvbnMgPSB7fSwKICAgICAgICBtYXBfYmFzZV9vcHRpb25zID0gewogICAgICAgICAgem9vbTogdGhpcy56b29tLAogICAgICAgICAgY2VudGVyOiBtYXBfY2VudGVyLAogICAgICAgICAgbWFwVHlwZUlkOiBtYXBUeXBlCiAgICAgICAgfSwKICAgICAgICBtYXBfY29udHJvbHNfb3B0aW9ucyA9IHsKICAgICAgICAgIHBhbkNvbnRyb2w6IHBhbkNvbnRyb2wsCiAgICAgICAgICB6b29tQ29udHJvbDogem9vbUNvbnRyb2wsCiAgICAgICAgICB6b29tQ29udHJvbE9wdGlvbnM6IHsKICAgICAgICAgICAgc3R5bGU6IGdvb2dsZS5tYXBzLlpvb21Db250cm9sU3R5bGVbem9vbUNvbnRyb2xTdHlsZV0sCiAgICAgICAgICAgIHBvc2l0aW9uOiBnb29nbGUubWFwcy5Db250cm9sUG9zaXRpb25bem9vbUNvbnRyb2xQb3NpdGlvbl0KICAgICAgICAgIH0sCiAgICAgICAgICBtYXBUeXBlQ29udHJvbDogbWFwVHlwZUNvbnRyb2wsCiAgICAgICAgICBzY2FsZUNvbnRyb2w6IHNjYWxlQ29udHJvbCwKICAgICAgICAgIHN0cmVldFZpZXdDb250cm9sOiBzdHJlZXRWaWV3Q29udHJvbCwKICAgICAgICAgIG92ZXJ2aWV3TWFwQ29udHJvbDogb3ZlcnZpZXdNYXBDb250cm9sCiAgICAgICAgfTsKCiAgICAgIGlmICh0eXBlb2Yob3B0aW9ucy5lbCkgPT09ICdzdHJpbmcnIHx8IHR5cGVvZihvcHRpb25zLmRpdikgPT09ICdzdHJpbmcnKSB7CgogICAgICAgICAgaWYgKGlkZW50aWZpZXIuaW5kZXhPZigiIyIpID4gLTEpIHsKICAgICAgICAgICAgICB0aGlzLmVsID0gZ2V0RWxlbWVudEJ5SWQoaWRlbnRpZmllciwgb3B0aW9ucy5jb250ZXh0KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgdGhpcy5lbCA9IGdldEVsZW1lbnRzQnlDbGFzc05hbWUuYXBwbHkodGhpcywgW2lkZW50aWZpZXIsIG9wdGlvbnMuY29udGV4dF0pOwogICAgICAgICAgfQoKICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXMuZWwgPSBpZGVudGlmaWVyOwogICAgICB9CgogICAgaWYgKHR5cGVvZih0aGlzLmVsKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdGhpcy5lbCA9PT0gbnVsbCkgewogICAgICB0aHJvdyAnTm8gZWxlbWVudCBkZWZpbmVkLic7CiAgICB9CgogICAgd2luZG93LmNvbnRleHRfbWVudSA9IHdpbmRvdy5jb250ZXh0X21lbnUgfHwge307CiAgICB3aW5kb3cuY29udGV4dF9tZW51W3NlbGYuZWwuaWRdID0ge307CgogICAgdGhpcy5jb250cm9scyA9IFtdOwogICAgdGhpcy5vdmVybGF5cyA9IFtdOwogICAgdGhpcy5sYXllcnMgPSBbXTsgLy8gYXJyYXkgd2l0aCBrbWwvZ2VvcnNzIGFuZCBmdXNpb250YWJsZXMgbGF5ZXJzLCBjYW4gYmUgYXMgbWFueQogICAgdGhpcy5zaW5nbGVMYXllcnMgPSB7fTsgLy8gb2JqZWN0IHdpdGggdGhlIG90aGVyIGxheWVycywgb25seSBvbmUgcGVyIGxheWVyCiAgICB0aGlzLm1hcmtlcnMgPSBbXTsKICAgIHRoaXMucG9seWxpbmVzID0gW107CiAgICB0aGlzLnJvdXRlcyA9IFtdOwogICAgdGhpcy5wb2x5Z29ucyA9IFtdOwogICAgdGhpcy5pbmZvV2luZG93ID0gbnVsbDsKICAgIHRoaXMub3ZlcmxheV9lbCA9IG51bGw7CiAgICB0aGlzLnpvb20gPSBvcHRpb25zLnpvb207CiAgICB0aGlzLnJlZ2lzdGVyZWRfZXZlbnRzID0ge307CgogICAgdGhpcy5lbC5zdHlsZS53aWR0aCA9IG9wdGlvbnMud2lkdGggfHwgdGhpcy5lbC5zY3JvbGxXaWR0aCB8fCB0aGlzLmVsLm9mZnNldFdpZHRoOwogICAgdGhpcy5lbC5zdHlsZS5oZWlnaHQgPSBvcHRpb25zLmhlaWdodCB8fCB0aGlzLmVsLnNjcm9sbEhlaWdodCB8fCB0aGlzLmVsLm9mZnNldEhlaWdodDsKCiAgICBnb29nbGUubWFwcy52aXN1YWxSZWZyZXNoID0gb3B0aW9ucy5lbmFibGVOZXdTdHlsZTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgb3B0aW9uc190b19iZV9kZWxldGVkLmxlbmd0aDsgaSsrKSB7CiAgICAgIGRlbGV0ZSBvcHRpb25zW29wdGlvbnNfdG9fYmVfZGVsZXRlZFtpXV07CiAgICB9CgogICAgaWYob3B0aW9ucy5kaXNhYmxlRGVmYXVsdFVJICE9IHRydWUpIHsKICAgICAgbWFwX2Jhc2Vfb3B0aW9ucyA9IGV4dGVuZF9vYmplY3QobWFwX2Jhc2Vfb3B0aW9ucywgbWFwX2NvbnRyb2xzX29wdGlvbnMpOwogICAgfQoKICAgIG1hcF9vcHRpb25zID0gZXh0ZW5kX29iamVjdChtYXBfYmFzZV9vcHRpb25zLCBvcHRpb25zKTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRzX3RoYXRfaGlkZV9jb250ZXh0X21lbnUubGVuZ3RoOyBpKyspIHsKICAgICAgZGVsZXRlIG1hcF9vcHRpb25zW2V2ZW50c190aGF0X2hpZGVfY29udGV4dF9tZW51W2ldXTsKICAgIH0KCiAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRzX3RoYXRfZG9lc250X2hpZGVfY29udGV4dF9tZW51Lmxlbmd0aDsgaSsrKSB7CiAgICAgIGRlbGV0ZSBtYXBfb3B0aW9uc1tldmVudHNfdGhhdF9kb2VzbnRfaGlkZV9jb250ZXh0X21lbnVbaV1dOwogICAgfQoKICAgIHRoaXMubWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcCh0aGlzLmVsLCBtYXBfb3B0aW9ucyk7CgogICAgaWYgKG1hcmtlckNsdXN0ZXJlckZ1bmN0aW9uKSB7CiAgICAgIHRoaXMubWFya2VyQ2x1c3RlcmVyID0gbWFya2VyQ2x1c3RlcmVyRnVuY3Rpb24uYXBwbHkodGhpcywgW3RoaXMubWFwXSk7CiAgICB9CgogICAgdmFyIGJ1aWxkQ29udGV4dE1lbnVIVE1MID0gZnVuY3Rpb24oY29udHJvbCwgZSkgewogICAgICB2YXIgaHRtbCA9ICcnLAogICAgICAgICAgb3B0aW9ucyA9IHdpbmRvdy5jb250ZXh0X21lbnVbc2VsZi5lbC5pZF1bY29udHJvbF07CgogICAgICBmb3IgKHZhciBpIGluIG9wdGlvbnMpewogICAgICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGkpKSB7CiAgICAgICAgICB2YXIgb3B0aW9uID0gb3B0aW9uc1tpXTsKCiAgICAgICAgICBodG1sICs9ICc8bGk+PGEgaWQ9IicgKyBjb250cm9sICsgJ18nICsgaSArICciIGhyZWY9IiMiPicgKyBvcHRpb24udGl0bGUgKyAnPC9hPjwvbGk+JzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghZ2V0RWxlbWVudEJ5SWQoJ2dtYXBzX2NvbnRleHRfbWVudScpKSByZXR1cm47CgogICAgICB2YXIgY29udGV4dF9tZW51X2VsZW1lbnQgPSBnZXRFbGVtZW50QnlJZCgnZ21hcHNfY29udGV4dF9tZW51Jyk7CgogICAgICBjb250ZXh0X21lbnVfZWxlbWVudC5pbm5lckhUTUwgPSBodG1sOwoKICAgICAgdmFyIGNvbnRleHRfbWVudV9pdGVtcyA9IGNvbnRleHRfbWVudV9lbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhJyksCiAgICAgICAgICBjb250ZXh0X21lbnVfaXRlbXNfY291bnQgPSBjb250ZXh0X21lbnVfaXRlbXMubGVuZ3RoLAogICAgICAgICAgaTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBjb250ZXh0X21lbnVfaXRlbXNfY291bnQ7IGkrKykgewogICAgICAgIHZhciBjb250ZXh0X21lbnVfaXRlbSA9IGNvbnRleHRfbWVudV9pdGVtc1tpXTsKCiAgICAgICAgdmFyIGFzc2lnbl9tZW51X2l0ZW1fYWN0aW9uID0gZnVuY3Rpb24oZXYpewogICAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgICBvcHRpb25zW3RoaXMuaWQucmVwbGFjZShjb250cm9sICsgJ18nLCAnJyldLmFjdGlvbi5hcHBseShzZWxmLCBbZV0pOwogICAgICAgICAgc2VsZi5oaWRlQ29udGV4dE1lbnUoKTsKICAgICAgICB9OwoKICAgICAgICBnb29nbGUubWFwcy5ldmVudC5jbGVhckxpc3RlbmVycyhjb250ZXh0X21lbnVfaXRlbSwgJ2NsaWNrJyk7CiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkRG9tTGlzdGVuZXJPbmNlKGNvbnRleHRfbWVudV9pdGVtLCAnY2xpY2snLCBhc3NpZ25fbWVudV9pdGVtX2FjdGlvbiwgZmFsc2UpOwogICAgICB9CgogICAgICB2YXIgcG9zaXRpb24gPSBmaW5kQWJzb2x1dGVQb3NpdGlvbi5hcHBseSh0aGlzLCBbc2VsZi5lbF0pLAogICAgICAgICAgbGVmdCA9IHBvc2l0aW9uWzBdICsgZS5waXhlbC54IC0gMTUsCiAgICAgICAgICB0b3AgPSBwb3NpdGlvblsxXSArIGUucGl4ZWwueS0gMTU7CgogICAgICBjb250ZXh0X21lbnVfZWxlbWVudC5zdHlsZS5sZWZ0ID0gbGVmdCArICJweCI7CiAgICAgIGNvbnRleHRfbWVudV9lbGVtZW50LnN0eWxlLnRvcCA9IHRvcCArICJweCI7CgogICAgICAvLyBjb250ZXh0X21lbnVfZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgIH07CgogICAgdGhpcy5idWlsZENvbnRleHRNZW51ID0gZnVuY3Rpb24oY29udHJvbCwgZSkgewogICAgICBpZiAoY29udHJvbCA9PT0gJ21hcmtlcicpIHsKICAgICAgICBlLnBpeGVsID0ge307CgogICAgICAgIHZhciBvdmVybGF5ID0gbmV3IGdvb2dsZS5tYXBzLk92ZXJsYXlWaWV3KCk7CiAgICAgICAgb3ZlcmxheS5zZXRNYXAoc2VsZi5tYXApOwoKICAgICAgICBvdmVybGF5LmRyYXcgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHZhciBwcm9qZWN0aW9uID0gb3ZlcmxheS5nZXRQcm9qZWN0aW9uKCksCiAgICAgICAgICAgICAgcG9zaXRpb24gPSBlLm1hcmtlci5nZXRQb3NpdGlvbigpOwoKICAgICAgICAgIGUucGl4ZWwgPSBwcm9qZWN0aW9uLmZyb21MYXRMbmdUb0NvbnRhaW5lclBpeGVsKHBvc2l0aW9uKTsKCiAgICAgICAgICBidWlsZENvbnRleHRNZW51SFRNTChjb250cm9sLCBlKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIGJ1aWxkQ29udGV4dE1lbnVIVE1MKGNvbnRyb2wsIGUpOwogICAgICB9CgogICAgICB2YXIgY29udGV4dF9tZW51X2VsZW1lbnQgPSBnZXRFbGVtZW50QnlJZCgnZ21hcHNfY29udGV4dF9tZW51Jyk7CgogICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIGNvbnRleHRfbWVudV9lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICB9LCAwKTsKICAgIH07CgogICAgdGhpcy5zZXRDb250ZXh0TWVudSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgd2luZG93LmNvbnRleHRfbWVudVtzZWxmLmVsLmlkXVtvcHRpb25zLmNvbnRyb2xdID0ge307CgogICAgICB2YXIgaSwKICAgICAgICAgIHVsID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ3VsJyk7CgogICAgICBmb3IgKGkgaW4gb3B0aW9ucy5vcHRpb25zKSB7CiAgICAgICAgaWYgKG9wdGlvbnMub3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShpKSkgewogICAgICAgICAgdmFyIG9wdGlvbiA9IG9wdGlvbnMub3B0aW9uc1tpXTsKCiAgICAgICAgICB3aW5kb3cuY29udGV4dF9tZW51W3NlbGYuZWwuaWRdW29wdGlvbnMuY29udHJvbF1bb3B0aW9uLm5hbWVdID0gewogICAgICAgICAgICB0aXRsZTogb3B0aW9uLnRpdGxlLAogICAgICAgICAgICBhY3Rpb246IG9wdGlvbi5hY3Rpb24KICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CgogICAgICB1bC5pZCA9ICdnbWFwc19jb250ZXh0X21lbnUnOwogICAgICB1bC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICB1bC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgIHVsLnN0eWxlLm1pbldpZHRoID0gJzEwMHB4JzsKICAgICAgdWwuc3R5bGUuYmFja2dyb3VuZCA9ICd3aGl0ZSc7CiAgICAgIHVsLnN0eWxlLmxpc3RTdHlsZSA9ICdub25lJzsKICAgICAgdWwuc3R5bGUucGFkZGluZyA9ICc4cHgnOwogICAgICB1bC5zdHlsZS5ib3hTaGFkb3cgPSAnMnB4IDJweCA2cHggI2NjYyc7CgogICAgICBpZiAoIWdldEVsZW1lbnRCeUlkKCdnbWFwc19jb250ZXh0X21lbnUnKSkgewogICAgICAgIGRvYy5ib2R5LmFwcGVuZENoaWxkKHVsKTsKICAgICAgfQoKICAgICAgdmFyIGNvbnRleHRfbWVudV9lbGVtZW50ID0gZ2V0RWxlbWVudEJ5SWQoJ2dtYXBzX2NvbnRleHRfbWVudScpOwoKICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkRG9tTGlzdGVuZXIoY29udGV4dF9tZW51X2VsZW1lbnQsICdtb3VzZW91dCcsIGZ1bmN0aW9uKGV2KSB7CiAgICAgICAgaWYgKCFldi5yZWxhdGVkVGFyZ2V0IHx8ICF0aGlzLmNvbnRhaW5zKGV2LnJlbGF0ZWRUYXJnZXQpKSB7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICBjb250ZXh0X21lbnVfZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgfSwgNDAwKTsKICAgICAgICB9CiAgICAgIH0sIGZhbHNlKTsKICAgIH07CgogICAgdGhpcy5oaWRlQ29udGV4dE1lbnUgPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHRfbWVudV9lbGVtZW50ID0gZ2V0RWxlbWVudEJ5SWQoJ2dtYXBzX2NvbnRleHRfbWVudScpOwoKICAgICAgaWYgKGNvbnRleHRfbWVudV9lbGVtZW50KSB7CiAgICAgICAgY29udGV4dF9tZW51X2VsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgfQogICAgfTsKCiAgICB2YXIgc2V0dXBMaXN0ZW5lciA9IGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKGUpewogICAgICAgIGlmIChlID09IHVuZGVmaW5lZCkgewogICAgICAgICAgZSA9IHRoaXM7CiAgICAgICAgfQoKICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIFtlXSk7CgogICAgICAgIHNlbGYuaGlkZUNvbnRleHRNZW51KCk7CiAgICAgIH0pOwogICAgfTsKCiAgICAvL2dvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKHRoaXMubWFwLCAnaWRsZScsIHRoaXMuaGlkZUNvbnRleHRNZW51KTsKICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKHRoaXMubWFwLCAnem9vbV9jaGFuZ2VkJywgdGhpcy5oaWRlQ29udGV4dE1lbnUpOwoKICAgIGZvciAodmFyIGV2ID0gMDsgZXYgPCBldmVudHNfdGhhdF9oaWRlX2NvbnRleHRfbWVudS5sZW5ndGg7IGV2KyspIHsKICAgICAgdmFyIG5hbWUgPSBldmVudHNfdGhhdF9oaWRlX2NvbnRleHRfbWVudVtldl07CgogICAgICBpZiAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgc2V0dXBMaXN0ZW5lcih0aGlzLm1hcCwgbmFtZSk7CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKHZhciBldiA9IDA7IGV2IDwgZXZlbnRzX3RoYXRfZG9lc250X2hpZGVfY29udGV4dF9tZW51Lmxlbmd0aDsgZXYrKykgewogICAgICB2YXIgbmFtZSA9IGV2ZW50c190aGF0X2RvZXNudF9oaWRlX2NvbnRleHRfbWVudVtldl07CgogICAgICBpZiAobmFtZSBpbiBvcHRpb25zKSB7CiAgICAgICAgc2V0dXBMaXN0ZW5lcih0aGlzLm1hcCwgbmFtZSk7CiAgICAgIH0KICAgIH0KCiAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcih0aGlzLm1hcCwgJ3JpZ2h0Y2xpY2snLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChvcHRpb25zLnJpZ2h0Y2xpY2spIHsKICAgICAgICBvcHRpb25zLnJpZ2h0Y2xpY2suYXBwbHkodGhpcywgW2VdKTsKICAgICAgfQoKICAgICAgaWYod2luZG93LmNvbnRleHRfbWVudVtzZWxmLmVsLmlkXVsnbWFwJ10gIT0gdW5kZWZpbmVkKSB7CiAgICAgICAgc2VsZi5idWlsZENvbnRleHRNZW51KCdtYXAnLCBlKTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy5yZWZyZXNoID0gZnVuY3Rpb24oKSB7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LnRyaWdnZXIodGhpcy5tYXAsICdyZXNpemUnKTsKICAgIH07CgogICAgdGhpcy5maXRab29tID0gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsYXRMbmdzID0gW10sCiAgICAgICAgICBtYXJrZXJzX2xlbmd0aCA9IHRoaXMubWFya2Vycy5sZW5ndGgsCiAgICAgICAgICBpOwoKICAgICAgZm9yIChpID0gMDsgaSA8IG1hcmtlcnNfbGVuZ3RoOyBpKyspIHsKICAgICAgICBpZih0eXBlb2YodGhpcy5tYXJrZXJzW2ldLnZpc2libGUpID09PSAnYm9vbGVhbicgJiYgdGhpcy5tYXJrZXJzW2ldLnZpc2libGUpIHsKICAgICAgICAgIGxhdExuZ3MucHVzaCh0aGlzLm1hcmtlcnNbaV0uZ2V0UG9zaXRpb24oKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLmZpdExhdExuZ0JvdW5kcyhsYXRMbmdzKTsKICAgIH07CgogICAgdGhpcy5maXRMYXRMbmdCb3VuZHMgPSBmdW5jdGlvbihsYXRMbmdzKSB7CiAgICAgIHZhciB0b3RhbCA9IGxhdExuZ3MubGVuZ3RoLAogICAgICAgICAgYm91bmRzID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZ0JvdW5kcygpLAogICAgICAgICAgaTsKCiAgICAgIGZvcihpID0gMDsgaSA8IHRvdGFsOyBpKyspIHsKICAgICAgICBib3VuZHMuZXh0ZW5kKGxhdExuZ3NbaV0pOwogICAgICB9CgogICAgICB0aGlzLm1hcC5maXRCb3VuZHMoYm91bmRzKTsKICAgIH07CgogICAgdGhpcy5zZXRDZW50ZXIgPSBmdW5jdGlvbihsYXQsIGxuZywgY2FsbGJhY2spIHsKICAgICAgdGhpcy5tYXAucGFuVG8obmV3IGdvb2dsZS5tYXBzLkxhdExuZyhsYXQsIGxuZykpOwoKICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgY2FsbGJhY2soKTsKICAgICAgfQogICAgfTsKCiAgICB0aGlzLmdldEVsZW1lbnQgPSBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMuZWw7CiAgICB9OwoKICAgIHRoaXMuem9vbUluID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAxOwoKICAgICAgdGhpcy56b29tID0gdGhpcy5tYXAuZ2V0Wm9vbSgpICsgdmFsdWU7CiAgICAgIHRoaXMubWFwLnNldFpvb20odGhpcy56b29tKTsKICAgIH07CgogICAgdGhpcy56b29tT3V0ID0gZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAxOwoKICAgICAgdGhpcy56b29tID0gdGhpcy5tYXAuZ2V0Wm9vbSgpIC0gdmFsdWU7CiAgICAgIHRoaXMubWFwLnNldFpvb20odGhpcy56b29tKTsKICAgIH07CgogICAgdmFyIG5hdGl2ZV9tZXRob2RzID0gW10sCiAgICAgICAgbWV0aG9kOwoKICAgIGZvciAobWV0aG9kIGluIHRoaXMubWFwKSB7CiAgICAgIGlmICh0eXBlb2YodGhpcy5tYXBbbWV0aG9kXSkgPT0gJ2Z1bmN0aW9uJyAmJiAhdGhpc1ttZXRob2RdKSB7CiAgICAgICAgbmF0aXZlX21ldGhvZHMucHVzaChtZXRob2QpOwogICAgICB9CiAgICB9CgogICAgZm9yIChpID0gMDsgaSA8IG5hdGl2ZV9tZXRob2RzLmxlbmd0aDsgaSsrKSB7CiAgICAgIChmdW5jdGlvbihnbWFwcywgc2NvcGUsIG1ldGhvZF9uYW1lKSB7CiAgICAgICAgZ21hcHNbbWV0aG9kX25hbWVdID0gZnVuY3Rpb24oKXsKICAgICAgICAgIHJldHVybiBzY29wZVttZXRob2RfbmFtZV0uYXBwbHkoc2NvcGUsIGFyZ3VtZW50cyk7CiAgICAgICAgfTsKICAgICAgfSkodGhpcywgdGhpcy5tYXAsIG5hdGl2ZV9tZXRob2RzW2ldKTsKICAgIH0KICB9OwoKICByZXR1cm4gR01hcHM7Cn0pKHRoaXMpOwoKR01hcHMucHJvdG90eXBlLmNyZWF0ZUNvbnRyb2wgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIGNvbnRyb2wgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCiAgY29udHJvbC5zdHlsZS5jdXJzb3IgPSAncG9pbnRlcic7CgogIGlmIChvcHRpb25zLmRpc2FibGVEZWZhdWx0U3R5bGVzICE9PSB0cnVlKSB7CiAgICBjb250cm9sLnN0eWxlLmZvbnRGYW1pbHkgPSAnUm9ib3RvLCBBcmlhbCwgc2Fucy1zZXJpZic7CiAgICBjb250cm9sLnN0eWxlLmZvbnRTaXplID0gJzExcHgnOwogICAgY29udHJvbC5zdHlsZS5ib3hTaGFkb3cgPSAncmdiYSgwLCAwLCAwLCAwLjI5ODAzOSkgMHB4IDFweCA0cHggLTFweCc7CiAgfQoKICBmb3IgKHZhciBvcHRpb24gaW4gb3B0aW9ucy5zdHlsZSkgewogICAgY29udHJvbC5zdHlsZVtvcHRpb25dID0gb3B0aW9ucy5zdHlsZVtvcHRpb25dOwogIH0KCiAgaWYgKG9wdGlvbnMuaWQpIHsKICAgIGNvbnRyb2wuaWQgPSBvcHRpb25zLmlkOwogIH0KCiAgaWYgKG9wdGlvbnMudGl0bGUpIHsKICAgIGNvbnRyb2wudGl0bGUgPSBvcHRpb25zLnRpdGxlOwogIH0KCiAgaWYgKG9wdGlvbnMuY2xhc3NlcykgewogICAgY29udHJvbC5jbGFzc05hbWUgPSBvcHRpb25zLmNsYXNzZXM7CiAgfQoKICBpZiAob3B0aW9ucy5jb250ZW50KSB7CiAgICBpZiAodHlwZW9mIG9wdGlvbnMuY29udGVudCA9PT0gJ3N0cmluZycpIHsKICAgICAgY29udHJvbC5pbm5lckhUTUwgPSBvcHRpb25zLmNvbnRlbnQ7CiAgICB9CiAgICBlbHNlIGlmIChvcHRpb25zLmNvbnRlbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgewogICAgICBjb250cm9sLmFwcGVuZENoaWxkKG9wdGlvbnMuY29udGVudCk7CiAgICB9CiAgfQoKICBpZiAob3B0aW9ucy5wb3NpdGlvbikgewogICAgY29udHJvbC5wb3NpdGlvbiA9IGdvb2dsZS5tYXBzLkNvbnRyb2xQb3NpdGlvbltvcHRpb25zLnBvc2l0aW9uLnRvVXBwZXJDYXNlKCldOwogIH0KCiAgZm9yICh2YXIgZXYgaW4gb3B0aW9ucy5ldmVudHMpIHsKICAgIChmdW5jdGlvbihvYmplY3QsIG5hbWUpIHsKICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkRG9tTGlzdGVuZXIob2JqZWN0LCBuYW1lLCBmdW5jdGlvbigpewogICAgICAgIG9wdGlvbnMuZXZlbnRzW25hbWVdLmFwcGx5KHRoaXMsIFt0aGlzXSk7CiAgICAgIH0pOwogICAgfSkoY29udHJvbCwgZXYpOwogIH0KCiAgY29udHJvbC5pbmRleCA9IDE7CgogIHJldHVybiBjb250cm9sOwp9OwoKR01hcHMucHJvdG90eXBlLmFkZENvbnRyb2wgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIGNvbnRyb2wgPSB0aGlzLmNyZWF0ZUNvbnRyb2wob3B0aW9ucyk7CgogIHRoaXMuY29udHJvbHMucHVzaChjb250cm9sKTsKICB0aGlzLm1hcC5jb250cm9sc1tjb250cm9sLnBvc2l0aW9uXS5wdXNoKGNvbnRyb2wpOwoKICByZXR1cm4gY29udHJvbDsKfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVDb250cm9sID0gZnVuY3Rpb24oY29udHJvbCkgewogIHZhciBwb3NpdGlvbiA9IG51bGwsCiAgICAgIGk7CgogIGZvciAoaSA9IDA7IGkgPCB0aGlzLmNvbnRyb2xzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGhpcy5jb250cm9sc1tpXSA9PSBjb250cm9sKSB7CiAgICAgIHBvc2l0aW9uID0gdGhpcy5jb250cm9sc1tpXS5wb3NpdGlvbjsKICAgICAgdGhpcy5jb250cm9scy5zcGxpY2UoaSwgMSk7CiAgICB9CiAgfQoKICBpZiAocG9zaXRpb24pIHsKICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLm1hcC5jb250cm9scy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgY29udHJvbHNGb3JQb3NpdGlvbiA9IHRoaXMubWFwLmNvbnRyb2xzW2NvbnRyb2wucG9zaXRpb25dOwoKICAgICAgaWYgKGNvbnRyb2xzRm9yUG9zaXRpb24uZ2V0QXQoaSkgPT0gY29udHJvbCkgewogICAgICAgIGNvbnRyb2xzRm9yUG9zaXRpb24ucmVtb3ZlQXQoaSk7CgogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfQoKICByZXR1cm4gY29udHJvbDsKfTsKCkdNYXBzLnByb3RvdHlwZS5jcmVhdGVNYXJrZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgaWYgKG9wdGlvbnMubGF0ID09IHVuZGVmaW5lZCAmJiBvcHRpb25zLmxuZyA9PSB1bmRlZmluZWQgJiYgb3B0aW9ucy5wb3NpdGlvbiA9PSB1bmRlZmluZWQpIHsKICAgIHRocm93ICdObyBsYXRpdHVkZSBvciBsb25naXR1ZGUgZGVmaW5lZC4nOwogIH0KCiAgdmFyIHNlbGYgPSB0aGlzLAogICAgICBkZXRhaWxzID0gb3B0aW9ucy5kZXRhaWxzLAogICAgICBmZW5jZXMgPSBvcHRpb25zLmZlbmNlcywKICAgICAgb3V0c2lkZSA9IG9wdGlvbnMub3V0c2lkZSwKICAgICAgYmFzZV9vcHRpb25zID0gewogICAgICAgIHBvc2l0aW9uOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKG9wdGlvbnMubGF0LCBvcHRpb25zLmxuZyksCiAgICAgICAgbWFwOiBudWxsCiAgICAgIH0sCiAgICAgIG1hcmtlcl9vcHRpb25zID0gZXh0ZW5kX29iamVjdChiYXNlX29wdGlvbnMsIG9wdGlvbnMpOwoKICBkZWxldGUgbWFya2VyX29wdGlvbnMubGF0OwogIGRlbGV0ZSBtYXJrZXJfb3B0aW9ucy5sbmc7CiAgZGVsZXRlIG1hcmtlcl9vcHRpb25zLmZlbmNlczsKICBkZWxldGUgbWFya2VyX29wdGlvbnMub3V0c2lkZTsKCiAgdmFyIG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIobWFya2VyX29wdGlvbnMpOwoKICBtYXJrZXIuZmVuY2VzID0gZmVuY2VzOwoKICBpZiAob3B0aW9ucy5pbmZvV2luZG93KSB7CiAgICBtYXJrZXIuaW5mb1dpbmRvdyA9IG5ldyBnb29nbGUubWFwcy5JbmZvV2luZG93KG9wdGlvbnMuaW5mb1dpbmRvdyk7CgogICAgdmFyIGluZm9fd2luZG93X2V2ZW50cyA9IFsnY2xvc2VjbGljaycsICdjb250ZW50X2NoYW5nZWQnLCAnZG9tcmVhZHknLCAncG9zaXRpb25fY2hhbmdlZCcsICd6aW5kZXhfY2hhbmdlZCddOwoKICAgIGZvciAodmFyIGV2ID0gMDsgZXYgPCBpbmZvX3dpbmRvd19ldmVudHMubGVuZ3RoOyBldisrKSB7CiAgICAgIChmdW5jdGlvbihvYmplY3QsIG5hbWUpIHsKICAgICAgICBpZiAob3B0aW9ucy5pbmZvV2luZG93W25hbWVdKSB7CiAgICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKGUpewogICAgICAgICAgICBvcHRpb25zLmluZm9XaW5kb3dbbmFtZV0uYXBwbHkodGhpcywgW2VdKTsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSkobWFya2VyLmluZm9XaW5kb3csIGluZm9fd2luZG93X2V2ZW50c1tldl0pOwogICAgfQogIH0KCiAgdmFyIG1hcmtlcl9ldmVudHMgPSBbJ2FuaW1hdGlvbl9jaGFuZ2VkJywgJ2NsaWNrYWJsZV9jaGFuZ2VkJywgJ2N1cnNvcl9jaGFuZ2VkJywgJ2RyYWdnYWJsZV9jaGFuZ2VkJywgJ2ZsYXRfY2hhbmdlZCcsICdpY29uX2NoYW5nZWQnLCAncG9zaXRpb25fY2hhbmdlZCcsICdzaGFkb3dfY2hhbmdlZCcsICdzaGFwZV9jaGFuZ2VkJywgJ3RpdGxlX2NoYW5nZWQnLCAndmlzaWJsZV9jaGFuZ2VkJywgJ3ppbmRleF9jaGFuZ2VkJ107CgogIHZhciBtYXJrZXJfZXZlbnRzX3dpdGhfbW91c2UgPSBbJ2RibGNsaWNrJywgJ2RyYWcnLCAnZHJhZ2VuZCcsICdkcmFnc3RhcnQnLCAnbW91c2Vkb3duJywgJ21vdXNlb3V0JywgJ21vdXNlb3ZlcicsICdtb3VzZXVwJ107CgogIGZvciAodmFyIGV2ID0gMDsgZXYgPCBtYXJrZXJfZXZlbnRzLmxlbmd0aDsgZXYrKykgewogICAgKGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICBpZiAob3B0aW9uc1tuYW1lXSkgewogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oKXsKICAgICAgICAgIG9wdGlvbnNbbmFtZV0uYXBwbHkodGhpcywgW3RoaXNdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSkobWFya2VyLCBtYXJrZXJfZXZlbnRzW2V2XSk7CiAgfQoKICBmb3IgKHZhciBldiA9IDA7IGV2IDwgbWFya2VyX2V2ZW50c193aXRoX21vdXNlLmxlbmd0aDsgZXYrKykgewogICAgKGZ1bmN0aW9uKG1hcCwgb2JqZWN0LCBuYW1lKSB7CiAgICAgIGlmIChvcHRpb25zW25hbWVdKSB7CiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIob2JqZWN0LCBuYW1lLCBmdW5jdGlvbihtZSl7CiAgICAgICAgICBpZighbWUucGl4ZWwpewogICAgICAgICAgICBtZS5waXhlbCA9IG1hcC5nZXRQcm9qZWN0aW9uKCkuZnJvbUxhdExuZ1RvUG9pbnQobWUubGF0TG5nKQogICAgICAgICAgfQoKICAgICAgICAgIG9wdGlvbnNbbmFtZV0uYXBwbHkodGhpcywgW21lXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pKHRoaXMubWFwLCBtYXJrZXIsIG1hcmtlcl9ldmVudHNfd2l0aF9tb3VzZVtldl0pOwogIH0KCiAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnY2xpY2snLCBmdW5jdGlvbigpIHsKICAgIHRoaXMuZGV0YWlscyA9IGRldGFpbHM7CgogICAgaWYgKG9wdGlvbnMuY2xpY2spIHsKICAgICAgb3B0aW9ucy5jbGljay5hcHBseSh0aGlzLCBbdGhpc10pOwogICAgfQoKICAgIGlmIChtYXJrZXIuaW5mb1dpbmRvdykgewogICAgICBzZWxmLmhpZGVJbmZvV2luZG93cygpOwogICAgICBtYXJrZXIuaW5mb1dpbmRvdy5vcGVuKHNlbGYubWFwLCBtYXJrZXIpOwogICAgfQogIH0pOwoKICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsICdyaWdodGNsaWNrJywgZnVuY3Rpb24oZSkgewogICAgZS5tYXJrZXIgPSB0aGlzOwoKICAgIGlmIChvcHRpb25zLnJpZ2h0Y2xpY2spIHsKICAgICAgb3B0aW9ucy5yaWdodGNsaWNrLmFwcGx5KHRoaXMsIFtlXSk7CiAgICB9CgogICAgaWYgKHdpbmRvdy5jb250ZXh0X21lbnVbc2VsZi5lbC5pZF1bJ21hcmtlciddICE9IHVuZGVmaW5lZCkgewogICAgICBzZWxmLmJ1aWxkQ29udGV4dE1lbnUoJ21hcmtlcicsIGUpOwogICAgfQogIH0pOwoKICBpZiAobWFya2VyLmZlbmNlcykgewogICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIobWFya2VyLCAnZHJhZ2VuZCcsIGZ1bmN0aW9uKCkgewogICAgICBzZWxmLmNoZWNrTWFya2VyR2VvZmVuY2UobWFya2VyLCBmdW5jdGlvbihtLCBmKSB7CiAgICAgICAgb3V0c2lkZShtLCBmKTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIHJldHVybiBtYXJrZXI7Cn07CgpHTWFwcy5wcm90b3R5cGUuYWRkTWFya2VyID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBtYXJrZXI7CiAgaWYob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnZ21fYWNjZXNzb3JzXycpKSB7CiAgICAvLyBOYXRpdmUgZ29vZ2xlLm1hcHMuTWFya2VyIG9iamVjdAogICAgbWFya2VyID0gb3B0aW9uczsKICB9CiAgZWxzZSB7CiAgICBpZiAoKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ2xhdCcpICYmIG9wdGlvbnMuaGFzT3duUHJvcGVydHkoJ2xuZycpKSB8fCBvcHRpb25zLnBvc2l0aW9uKSB7CiAgICAgIG1hcmtlciA9IHRoaXMuY3JlYXRlTWFya2VyKG9wdGlvbnMpOwogICAgfQogICAgZWxzZSB7CiAgICAgIHRocm93ICdObyBsYXRpdHVkZSBvciBsb25naXR1ZGUgZGVmaW5lZC4nOwogICAgfQogIH0KCiAgbWFya2VyLnNldE1hcCh0aGlzLm1hcCk7CgogIGlmKHRoaXMubWFya2VyQ2x1c3RlcmVyKSB7CiAgICB0aGlzLm1hcmtlckNsdXN0ZXJlci5hZGRNYXJrZXIobWFya2VyKTsKICB9CgogIHRoaXMubWFya2Vycy5wdXNoKG1hcmtlcik7CgogIEdNYXBzLmZpcmUoJ21hcmtlcl9hZGRlZCcsIG1hcmtlciwgdGhpcyk7CgogIHJldHVybiBtYXJrZXI7Cn07CgpHTWFwcy5wcm90b3R5cGUuYWRkTWFya2VycyA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgZm9yICh2YXIgaSA9IDAsIG1hcmtlcjsgbWFya2VyPWFycmF5W2ldOyBpKyspIHsKICAgIHRoaXMuYWRkTWFya2VyKG1hcmtlcik7CiAgfQoKICByZXR1cm4gdGhpcy5tYXJrZXJzOwp9OwoKR01hcHMucHJvdG90eXBlLmhpZGVJbmZvV2luZG93cyA9IGZ1bmN0aW9uKCkgewogIGZvciAodmFyIGkgPSAwLCBtYXJrZXI7IG1hcmtlciA9IHRoaXMubWFya2Vyc1tpXTsgaSsrKXsKICAgIGlmIChtYXJrZXIuaW5mb1dpbmRvdykgewogICAgICBtYXJrZXIuaW5mb1dpbmRvdy5jbG9zZSgpOwogICAgfQogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVNYXJrZXIgPSBmdW5jdGlvbihtYXJrZXIpIHsKICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubWFya2Vycy5sZW5ndGg7IGkrKykgewogICAgaWYgKHRoaXMubWFya2Vyc1tpXSA9PT0gbWFya2VyKSB7CiAgICAgIHRoaXMubWFya2Vyc1tpXS5zZXRNYXAobnVsbCk7CiAgICAgIHRoaXMubWFya2Vycy5zcGxpY2UoaSwgMSk7CgogICAgICBpZih0aGlzLm1hcmtlckNsdXN0ZXJlcikgewogICAgICAgIHRoaXMubWFya2VyQ2x1c3RlcmVyLnJlbW92ZU1hcmtlcihtYXJrZXIpOwogICAgICB9CgogICAgICBHTWFwcy5maXJlKCdtYXJrZXJfcmVtb3ZlZCcsIG1hcmtlciwgdGhpcyk7CgogICAgICBicmVhazsKICAgIH0KICB9CgogIHJldHVybiBtYXJrZXI7Cn07CgpHTWFwcy5wcm90b3R5cGUucmVtb3ZlTWFya2VycyA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uKSB7CiAgdmFyIG5ld19tYXJrZXJzID0gW107CgogIGlmICh0eXBlb2YgY29sbGVjdGlvbiA9PSAndW5kZWZpbmVkJykgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLm1hcmtlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIG1hcmtlciA9IHRoaXMubWFya2Vyc1tpXTsKICAgICAgbWFya2VyLnNldE1hcChudWxsKTsKCiAgICAgIGlmKHRoaXMubWFya2VyQ2x1c3RlcmVyKSB7CiAgICAgICAgdGhpcy5tYXJrZXJDbHVzdGVyZXIucmVtb3ZlTWFya2VyKG1hcmtlcik7CiAgICAgIH0KCiAgICAgIEdNYXBzLmZpcmUoJ21hcmtlcl9yZW1vdmVkJywgbWFya2VyLCB0aGlzKTsKICAgIH0KCiAgICB0aGlzLm1hcmtlcnMgPSBuZXdfbWFya2VyczsKICB9CiAgZWxzZSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbGxlY3Rpb24ubGVuZ3RoOyBpKyspIHsKICAgICAgdmFyIGluZGV4ID0gdGhpcy5tYXJrZXJzLmluZGV4T2YoY29sbGVjdGlvbltpXSk7CgogICAgICBpZiAoaW5kZXggPiAtMSkgewogICAgICAgIHZhciBtYXJrZXIgPSB0aGlzLm1hcmtlcnNbaW5kZXhdOwogICAgICAgIG1hcmtlci5zZXRNYXAobnVsbCk7CgogICAgICAgIGlmKHRoaXMubWFya2VyQ2x1c3RlcmVyKSB7CiAgICAgICAgICB0aGlzLm1hcmtlckNsdXN0ZXJlci5yZW1vdmVNYXJrZXIobWFya2VyKTsKICAgICAgICB9CgogICAgICAgIEdNYXBzLmZpcmUoJ21hcmtlcl9yZW1vdmVkJywgbWFya2VyLCB0aGlzKTsKICAgICAgfQogICAgfQoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5tYXJrZXJzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHZhciBtYXJrZXIgPSB0aGlzLm1hcmtlcnNbaV07CiAgICAgIGlmIChtYXJrZXIuZ2V0TWFwKCkgIT0gbnVsbCkgewogICAgICAgIG5ld19tYXJrZXJzLnB1c2gobWFya2VyKTsKICAgICAgfQogICAgfQoKICAgIHRoaXMubWFya2VycyA9IG5ld19tYXJrZXJzOwogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5kcmF3T3ZlcmxheSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgb3ZlcmxheSA9IG5ldyBnb29nbGUubWFwcy5PdmVybGF5VmlldygpLAogICAgICBhdXRvX3Nob3cgPSB0cnVlOwoKICBvdmVybGF5LnNldE1hcCh0aGlzLm1hcCk7CgogIGlmIChvcHRpb25zLmF1dG9fc2hvdyAhPSBudWxsKSB7CiAgICBhdXRvX3Nob3cgPSBvcHRpb25zLmF1dG9fc2hvdzsKICB9CgogIG92ZXJsYXkub25BZGQgPSBmdW5jdGlvbigpIHsKICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKICAgIGVsLnN0eWxlLmJvcmRlclN0eWxlID0gIm5vbmUiOwogICAgZWwuc3R5bGUuYm9yZGVyV2lkdGggPSAiMHB4IjsKICAgIGVsLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgIGVsLnN0eWxlLnpJbmRleCA9IDEwMDsKICAgIGVsLmlubmVySFRNTCA9IG9wdGlvbnMuY29udGVudDsKCiAgICBvdmVybGF5LmVsID0gZWw7CgogICAgaWYgKCFvcHRpb25zLmxheWVyKSB7CiAgICAgIG9wdGlvbnMubGF5ZXIgPSAnb3ZlcmxheUxheWVyJzsKICAgIH0KCiAgICB2YXIgcGFuZXMgPSB0aGlzLmdldFBhbmVzKCksCiAgICAgICAgb3ZlcmxheUxheWVyID0gcGFuZXNbb3B0aW9ucy5sYXllcl0sCiAgICAgICAgc3RvcF9vdmVybGF5X2V2ZW50cyA9IFsnY29udGV4dG1lbnUnLCAnRE9NTW91c2VTY3JvbGwnLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJ107CgogICAgb3ZlcmxheUxheWVyLmFwcGVuZENoaWxkKGVsKTsKCiAgICBmb3IgKHZhciBldiA9IDA7IGV2IDwgc3RvcF9vdmVybGF5X2V2ZW50cy5sZW5ndGg7IGV2KyspIHsKICAgICAgKGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZERvbUxpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSl7CiAgICAgICAgICBpZiAobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ21zaWUnKSAhPSAtMSAmJiBkb2N1bWVudC5hbGwpIHsKICAgICAgICAgICAgZS5jYW5jZWxCdWJibGUgPSB0cnVlOwogICAgICAgICAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSkoZWwsIHN0b3Bfb3ZlcmxheV9ldmVudHNbZXZdKTsKICAgIH0KCiAgICBpZiAob3B0aW9ucy5jbGljaykgewogICAgICBwYW5lcy5vdmVybGF5TW91c2VUYXJnZXQuYXBwZW5kQ2hpbGQob3ZlcmxheS5lbCk7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZERvbUxpc3RlbmVyKG92ZXJsYXkuZWwsICdjbGljaycsIGZ1bmN0aW9uKCkgewogICAgICAgIG9wdGlvbnMuY2xpY2suYXBwbHkob3ZlcmxheSwgW292ZXJsYXldKTsKICAgICAgfSk7CiAgICB9CgogICAgZ29vZ2xlLm1hcHMuZXZlbnQudHJpZ2dlcih0aGlzLCAncmVhZHknKTsKICB9OwoKICBvdmVybGF5LmRyYXcgPSBmdW5jdGlvbigpIHsKICAgIHZhciBwcm9qZWN0aW9uID0gdGhpcy5nZXRQcm9qZWN0aW9uKCksCiAgICAgICAgcGl4ZWwgPSBwcm9qZWN0aW9uLmZyb21MYXRMbmdUb0RpdlBpeGVsKG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5sYXQsIG9wdGlvbnMubG5nKSk7CgogICAgb3B0aW9ucy5ob3Jpem9udGFsT2Zmc2V0ID0gb3B0aW9ucy5ob3Jpem9udGFsT2Zmc2V0IHx8IDA7CiAgICBvcHRpb25zLnZlcnRpY2FsT2Zmc2V0ID0gb3B0aW9ucy52ZXJ0aWNhbE9mZnNldCB8fCAwOwoKICAgIHZhciBlbCA9IG92ZXJsYXkuZWwsCiAgICAgICAgY29udGVudCA9IGVsLmNoaWxkcmVuWzBdLAogICAgICAgIGNvbnRlbnRfaGVpZ2h0ID0gY29udGVudC5jbGllbnRIZWlnaHQsCiAgICAgICAgY29udGVudF93aWR0aCA9IGNvbnRlbnQuY2xpZW50V2lkdGg7CgogICAgc3dpdGNoIChvcHRpb25zLnZlcnRpY2FsQWxpZ24pIHsKICAgICAgY2FzZSAndG9wJzoKICAgICAgICBlbC5zdHlsZS50b3AgPSAocGl4ZWwueSAtIGNvbnRlbnRfaGVpZ2h0ICsgb3B0aW9ucy52ZXJ0aWNhbE9mZnNldCkgKyAncHgnOwogICAgICAgIGJyZWFrOwogICAgICBkZWZhdWx0OgogICAgICBjYXNlICdtaWRkbGUnOgogICAgICAgIGVsLnN0eWxlLnRvcCA9IChwaXhlbC55IC0gKGNvbnRlbnRfaGVpZ2h0IC8gMikgKyBvcHRpb25zLnZlcnRpY2FsT2Zmc2V0KSArICdweCc7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ2JvdHRvbSc6CiAgICAgICAgZWwuc3R5bGUudG9wID0gKHBpeGVsLnkgKyBvcHRpb25zLnZlcnRpY2FsT2Zmc2V0KSArICdweCc7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgc3dpdGNoIChvcHRpb25zLmhvcml6b250YWxBbGlnbikgewogICAgICBjYXNlICdsZWZ0JzoKICAgICAgICBlbC5zdHlsZS5sZWZ0ID0gKHBpeGVsLnggLSBjb250ZW50X3dpZHRoICsgb3B0aW9ucy5ob3Jpem9udGFsT2Zmc2V0KSArICdweCc7CiAgICAgICAgYnJlYWs7CiAgICAgIGRlZmF1bHQ6CiAgICAgIGNhc2UgJ2NlbnRlcic6CiAgICAgICAgZWwuc3R5bGUubGVmdCA9IChwaXhlbC54IC0gKGNvbnRlbnRfd2lkdGggLyAyKSArIG9wdGlvbnMuaG9yaXpvbnRhbE9mZnNldCkgKyAncHgnOwogICAgICAgIGJyZWFrOwogICAgICBjYXNlICdyaWdodCc6CiAgICAgICAgZWwuc3R5bGUubGVmdCA9IChwaXhlbC54ICsgb3B0aW9ucy5ob3Jpem9udGFsT2Zmc2V0KSArICdweCc7CiAgICAgICAgYnJlYWs7CiAgICB9CgogICAgZWwuc3R5bGUuZGlzcGxheSA9IGF1dG9fc2hvdyA/ICdibG9jaycgOiAnbm9uZSc7CgogICAgaWYgKCFhdXRvX3Nob3cpIHsKICAgICAgb3B0aW9ucy5zaG93LmFwcGx5KHRoaXMsIFtlbF0pOwogICAgfQogIH07CgogIG92ZXJsYXkub25SZW1vdmUgPSBmdW5jdGlvbigpIHsKICAgIHZhciBlbCA9IG92ZXJsYXkuZWw7CgogICAgaWYgKG9wdGlvbnMucmVtb3ZlKSB7CiAgICAgIG9wdGlvbnMucmVtb3ZlLmFwcGx5KHRoaXMsIFtlbF0pOwogICAgfQogICAgZWxzZSB7CiAgICAgIG92ZXJsYXkuZWwucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChvdmVybGF5LmVsKTsKICAgICAgb3ZlcmxheS5lbCA9IG51bGw7CiAgICB9CiAgfTsKCiAgdGhpcy5vdmVybGF5cy5wdXNoKG92ZXJsYXkpOwogIHJldHVybiBvdmVybGF5Owp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZU92ZXJsYXkgPSBmdW5jdGlvbihvdmVybGF5KSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLm92ZXJsYXlzLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGhpcy5vdmVybGF5c1tpXSA9PT0gb3ZlcmxheSkgewogICAgICB0aGlzLm92ZXJsYXlzW2ldLnNldE1hcChudWxsKTsKICAgICAgdGhpcy5vdmVybGF5cy5zcGxpY2UoaSwgMSk7CgogICAgICBicmVhazsKICAgIH0KICB9Cn07CgpHTWFwcy5wcm90b3R5cGUucmVtb3ZlT3ZlcmxheXMgPSBmdW5jdGlvbigpIHsKICBmb3IgKHZhciBpID0gMCwgaXRlbTsgaXRlbSA9IHRoaXMub3ZlcmxheXNbaV07IGkrKykgewogICAgaXRlbS5zZXRNYXAobnVsbCk7CiAgfQoKICB0aGlzLm92ZXJsYXlzID0gW107Cn07CgpHTWFwcy5wcm90b3R5cGUuZHJhd1BvbHlsaW5lID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBwYXRoID0gW10sCiAgICAgIHBvaW50cyA9IG9wdGlvbnMucGF0aDsKCiAgaWYgKHBvaW50cy5sZW5ndGgpIHsKICAgIGlmIChwb2ludHNbMF1bMF0gPT09IHVuZGVmaW5lZCkgewogICAgICBwYXRoID0gcG9pbnRzOwogICAgfQogICAgZWxzZSB7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsYXRsbmc7IGxhdGxuZyA9IHBvaW50c1tpXTsgaSsrKSB7CiAgICAgICAgcGF0aC5wdXNoKG5ldyBnb29nbGUubWFwcy5MYXRMbmcobGF0bG5nWzBdLCBsYXRsbmdbMV0pKTsKICAgICAgfQogICAgfQogIH0KCiAgdmFyIHBvbHlsaW5lX29wdGlvbnMgPSB7CiAgICBtYXA6IHRoaXMubWFwLAogICAgcGF0aDogcGF0aCwKICAgIHN0cm9rZUNvbG9yOiBvcHRpb25zLnN0cm9rZUNvbG9yLAogICAgc3Ryb2tlT3BhY2l0eTogb3B0aW9ucy5zdHJva2VPcGFjaXR5LAogICAgc3Ryb2tlV2VpZ2h0OiBvcHRpb25zLnN0cm9rZVdlaWdodCwKICAgIGdlb2Rlc2ljOiBvcHRpb25zLmdlb2Rlc2ljLAogICAgY2xpY2thYmxlOiB0cnVlLAogICAgZWRpdGFibGU6IGZhbHNlLAogICAgdmlzaWJsZTogdHJ1ZQogIH07CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJjbGlja2FibGUiKSkgewogICAgcG9seWxpbmVfb3B0aW9ucy5jbGlja2FibGUgPSBvcHRpb25zLmNsaWNrYWJsZTsKICB9CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJlZGl0YWJsZSIpKSB7CiAgICBwb2x5bGluZV9vcHRpb25zLmVkaXRhYmxlID0gb3B0aW9ucy5lZGl0YWJsZTsKICB9CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJpY29ucyIpKSB7CiAgICBwb2x5bGluZV9vcHRpb25zLmljb25zID0gb3B0aW9ucy5pY29uczsKICB9CgogIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJ6SW5kZXgiKSkgewogICAgcG9seWxpbmVfb3B0aW9ucy56SW5kZXggPSBvcHRpb25zLnpJbmRleDsKICB9CgogIHZhciBwb2x5bGluZSA9IG5ldyBnb29nbGUubWFwcy5Qb2x5bGluZShwb2x5bGluZV9vcHRpb25zKTsKCiAgdmFyIHBvbHlsaW5lX2V2ZW50cyA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNlbW92ZScsICdtb3VzZW91dCcsICdtb3VzZW92ZXInLCAnbW91c2V1cCcsICdyaWdodGNsaWNrJ107CgogIGZvciAodmFyIGV2ID0gMDsgZXYgPCBwb2x5bGluZV9ldmVudHMubGVuZ3RoOyBldisrKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGlmIChvcHRpb25zW25hbWVdKSB7CiAgICAgICAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIob2JqZWN0LCBuYW1lLCBmdW5jdGlvbihlKXsKICAgICAgICAgIG9wdGlvbnNbbmFtZV0uYXBwbHkodGhpcywgW2VdKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSkocG9seWxpbmUsIHBvbHlsaW5lX2V2ZW50c1tldl0pOwogIH0KCiAgdGhpcy5wb2x5bGluZXMucHVzaChwb2x5bGluZSk7CgogIEdNYXBzLmZpcmUoJ3BvbHlsaW5lX2FkZGVkJywgcG9seWxpbmUsIHRoaXMpOwoKICByZXR1cm4gcG9seWxpbmU7Cn07CgpHTWFwcy5wcm90b3R5cGUucmVtb3ZlUG9seWxpbmUgPSBmdW5jdGlvbihwb2x5bGluZSkgewogIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5wb2x5bGluZXMubGVuZ3RoOyBpKyspIHsKICAgIGlmICh0aGlzLnBvbHlsaW5lc1tpXSA9PT0gcG9seWxpbmUpIHsKICAgICAgdGhpcy5wb2x5bGluZXNbaV0uc2V0TWFwKG51bGwpOwogICAgICB0aGlzLnBvbHlsaW5lcy5zcGxpY2UoaSwgMSk7CgogICAgICBHTWFwcy5maXJlKCdwb2x5bGluZV9yZW1vdmVkJywgcG9seWxpbmUsIHRoaXMpOwoKICAgICAgYnJlYWs7CiAgICB9CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZVBvbHlsaW5lcyA9IGZ1bmN0aW9uKCkgewogIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gdGhpcy5wb2x5bGluZXNbaV07IGkrKykgewogICAgaXRlbS5zZXRNYXAobnVsbCk7CiAgfQoKICB0aGlzLnBvbHlsaW5lcyA9IFtdOwp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdDaXJjbGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9ICBleHRlbmRfb2JqZWN0KHsKICAgIG1hcDogdGhpcy5tYXAsCiAgICBjZW50ZXI6IG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5sYXQsIG9wdGlvbnMubG5nKQogIH0sIG9wdGlvbnMpOwoKICBkZWxldGUgb3B0aW9ucy5sYXQ7CiAgZGVsZXRlIG9wdGlvbnMubG5nOwoKICB2YXIgcG9seWdvbiA9IG5ldyBnb29nbGUubWFwcy5DaXJjbGUob3B0aW9ucyksCiAgICAgIHBvbHlnb25fZXZlbnRzID0gWydjbGljaycsICdkYmxjbGljaycsICdtb3VzZWRvd24nLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3V0JywgJ21vdXNlb3ZlcicsICdtb3VzZXVwJywgJ3JpZ2h0Y2xpY2snXTsKCiAgZm9yICh2YXIgZXYgPSAwOyBldiA8IHBvbHlnb25fZXZlbnRzLmxlbmd0aDsgZXYrKykgewogICAgKGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICBpZiAob3B0aW9uc1tuYW1lXSkgewogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSl7CiAgICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIFtlXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pKHBvbHlnb24sIHBvbHlnb25fZXZlbnRzW2V2XSk7CiAgfQoKICB0aGlzLnBvbHlnb25zLnB1c2gocG9seWdvbik7CgogIHJldHVybiBwb2x5Z29uOwp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdSZWN0YW5nbGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IGV4dGVuZF9vYmplY3QoewogICAgbWFwOiB0aGlzLm1hcAogIH0sIG9wdGlvbnMpOwoKICB2YXIgbGF0TG5nQm91bmRzID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZ0JvdW5kcygKICAgIG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5ib3VuZHNbMF1bMF0sIG9wdGlvbnMuYm91bmRzWzBdWzFdKSwKICAgIG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5ib3VuZHNbMV1bMF0sIG9wdGlvbnMuYm91bmRzWzFdWzFdKQogICk7CgogIG9wdGlvbnMuYm91bmRzID0gbGF0TG5nQm91bmRzOwoKICB2YXIgcG9seWdvbiA9IG5ldyBnb29nbGUubWFwcy5SZWN0YW5nbGUob3B0aW9ucyksCiAgICAgIHBvbHlnb25fZXZlbnRzID0gWydjbGljaycsICdkYmxjbGljaycsICdtb3VzZWRvd24nLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3V0JywgJ21vdXNlb3ZlcicsICdtb3VzZXVwJywgJ3JpZ2h0Y2xpY2snXTsKCiAgZm9yICh2YXIgZXYgPSAwOyBldiA8IHBvbHlnb25fZXZlbnRzLmxlbmd0aDsgZXYrKykgewogICAgKGZ1bmN0aW9uKG9iamVjdCwgbmFtZSkgewogICAgICBpZiAob3B0aW9uc1tuYW1lXSkgewogICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSl7CiAgICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMsIFtlXSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pKHBvbHlnb24sIHBvbHlnb25fZXZlbnRzW2V2XSk7CiAgfQoKICB0aGlzLnBvbHlnb25zLnB1c2gocG9seWdvbik7CgogIHJldHVybiBwb2x5Z29uOwp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdQb2x5Z29uID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB1c2VHZW9KU09OID0gZmFsc2U7CgogIGlmKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoInVzZUdlb0pTT04iKSkgewogICAgdXNlR2VvSlNPTiA9IG9wdGlvbnMudXNlR2VvSlNPTjsKICB9CgogIGRlbGV0ZSBvcHRpb25zLnVzZUdlb0pTT047CgogIG9wdGlvbnMgPSBleHRlbmRfb2JqZWN0KHsKICAgIG1hcDogdGhpcy5tYXAKICB9LCBvcHRpb25zKTsKCiAgaWYgKHVzZUdlb0pTT04gPT0gZmFsc2UpIHsKICAgIG9wdGlvbnMucGF0aHMgPSBbb3B0aW9ucy5wYXRocy5zbGljZSgwKV07CiAgfQoKICBpZiAob3B0aW9ucy5wYXRocy5sZW5ndGggPiAwKSB7CiAgICBpZiAob3B0aW9ucy5wYXRoc1swXS5sZW5ndGggPiAwKSB7CiAgICAgIG9wdGlvbnMucGF0aHMgPSBhcnJheV9mbGF0KGFycmF5X21hcChvcHRpb25zLnBhdGhzLCBhcnJheVRvTGF0TG5nLCB1c2VHZW9KU09OKSk7CiAgICB9CiAgfQoKICB2YXIgcG9seWdvbiA9IG5ldyBnb29nbGUubWFwcy5Qb2x5Z29uKG9wdGlvbnMpLAogICAgICBwb2x5Z29uX2V2ZW50cyA9IFsnY2xpY2snLCAnZGJsY2xpY2snLCAnbW91c2Vkb3duJywgJ21vdXNlbW92ZScsICdtb3VzZW91dCcsICdtb3VzZW92ZXInLCAnbW91c2V1cCcsICdyaWdodGNsaWNrJ107CgogIGZvciAodmFyIGV2ID0gMDsgZXYgPCBwb2x5Z29uX2V2ZW50cy5sZW5ndGg7IGV2KyspIHsKICAgIChmdW5jdGlvbihvYmplY3QsIG5hbWUpIHsKICAgICAgaWYgKG9wdGlvbnNbbmFtZV0pIHsKICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKGUpewogICAgICAgICAgb3B0aW9uc1tuYW1lXS5hcHBseSh0aGlzLCBbZV0pOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KShwb2x5Z29uLCBwb2x5Z29uX2V2ZW50c1tldl0pOwogIH0KCiAgdGhpcy5wb2x5Z29ucy5wdXNoKHBvbHlnb24pOwoKICBHTWFwcy5maXJlKCdwb2x5Z29uX2FkZGVkJywgcG9seWdvbiwgdGhpcyk7CgogIHJldHVybiBwb2x5Z29uOwp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZVBvbHlnb24gPSBmdW5jdGlvbihwb2x5Z29uKSB7CiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnBvbHlnb25zLmxlbmd0aDsgaSsrKSB7CiAgICBpZiAodGhpcy5wb2x5Z29uc1tpXSA9PT0gcG9seWdvbikgewogICAgICB0aGlzLnBvbHlnb25zW2ldLnNldE1hcChudWxsKTsKICAgICAgdGhpcy5wb2x5Z29ucy5zcGxpY2UoaSwgMSk7CgogICAgICBHTWFwcy5maXJlKCdwb2x5Z29uX3JlbW92ZWQnLCBwb2x5Z29uLCB0aGlzKTsKCiAgICAgIGJyZWFrOwogICAgfQogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVQb2x5Z29ucyA9IGZ1bmN0aW9uKCkgewogIGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gdGhpcy5wb2x5Z29uc1tpXTsgaSsrKSB7CiAgICBpdGVtLnNldE1hcChudWxsKTsKICB9CgogIHRoaXMucG9seWdvbnMgPSBbXTsKfTsKCkdNYXBzLnByb3RvdHlwZS5nZXRGcm9tRnVzaW9uVGFibGVzID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBldmVudHMgPSBvcHRpb25zLmV2ZW50czsKCiAgZGVsZXRlIG9wdGlvbnMuZXZlbnRzOwoKICB2YXIgZnVzaW9uX3RhYmxlc19vcHRpb25zID0gb3B0aW9ucywKICAgICAgbGF5ZXIgPSBuZXcgZ29vZ2xlLm1hcHMuRnVzaW9uVGFibGVzTGF5ZXIoZnVzaW9uX3RhYmxlc19vcHRpb25zKTsKCiAgZm9yICh2YXIgZXYgaW4gZXZlbnRzKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSkgewogICAgICAgIGV2ZW50c1tuYW1lXS5hcHBseSh0aGlzLCBbZV0pOwogICAgICB9KTsKICAgIH0pKGxheWVyLCBldik7CiAgfQoKICB0aGlzLmxheWVycy5wdXNoKGxheWVyKTsKCiAgcmV0dXJuIGxheWVyOwp9OwoKR01hcHMucHJvdG90eXBlLmxvYWRGcm9tRnVzaW9uVGFibGVzID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBsYXllciA9IHRoaXMuZ2V0RnJvbUZ1c2lvblRhYmxlcyhvcHRpb25zKTsKICBsYXllci5zZXRNYXAodGhpcy5tYXApOwoKICByZXR1cm4gbGF5ZXI7Cn07CgpHTWFwcy5wcm90b3R5cGUuZ2V0RnJvbUtNTCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdXJsID0gb3B0aW9ucy51cmwsCiAgICAgIGV2ZW50cyA9IG9wdGlvbnMuZXZlbnRzOwoKICBkZWxldGUgb3B0aW9ucy51cmw7CiAgZGVsZXRlIG9wdGlvbnMuZXZlbnRzOwoKICB2YXIga21sX29wdGlvbnMgPSBvcHRpb25zLAogICAgICBsYXllciA9IG5ldyBnb29nbGUubWFwcy5LbWxMYXllcih1cmwsIGttbF9vcHRpb25zKTsKCiAgZm9yICh2YXIgZXYgaW4gZXZlbnRzKSB7CiAgICAoZnVuY3Rpb24ob2JqZWN0LCBuYW1lKSB7CiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG9iamVjdCwgbmFtZSwgZnVuY3Rpb24oZSkgewogICAgICAgIGV2ZW50c1tuYW1lXS5hcHBseSh0aGlzLCBbZV0pOwogICAgICB9KTsKICAgIH0pKGxheWVyLCBldik7CiAgfQoKICB0aGlzLmxheWVycy5wdXNoKGxheWVyKTsKCiAgcmV0dXJuIGxheWVyOwp9OwoKR01hcHMucHJvdG90eXBlLmxvYWRGcm9tS01MID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBsYXllciA9IHRoaXMuZ2V0RnJvbUtNTChvcHRpb25zKTsKICBsYXllci5zZXRNYXAodGhpcy5tYXApOwoKICByZXR1cm4gbGF5ZXI7Cn07CgpHTWFwcy5wcm90b3R5cGUuYWRkTGF5ZXIgPSBmdW5jdGlvbihsYXllck5hbWUsIG9wdGlvbnMpIHsKICAvL3ZhciBkZWZhdWx0X2xheWVycyA9IFsnd2VhdGhlcicsICdjbG91ZHMnLCAndHJhZmZpYycsICd0cmFuc2l0JywgJ2JpY3ljbGluZycsICdwYW5vcmFtaW8nLCAncGxhY2VzJ107CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgdmFyIGxheWVyOwoKICBzd2l0Y2gobGF5ZXJOYW1lKSB7CiAgICBjYXNlICd3ZWF0aGVyJzogdGhpcy5zaW5nbGVMYXllcnMud2VhdGhlciA9IGxheWVyID0gbmV3IGdvb2dsZS5tYXBzLndlYXRoZXIuV2VhdGhlckxheWVyKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAnY2xvdWRzJzogdGhpcy5zaW5nbGVMYXllcnMuY2xvdWRzID0gbGF5ZXIgPSBuZXcgZ29vZ2xlLm1hcHMud2VhdGhlci5DbG91ZExheWVyKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAndHJhZmZpYyc6IHRoaXMuc2luZ2xlTGF5ZXJzLnRyYWZmaWMgPSBsYXllciA9IG5ldyBnb29nbGUubWFwcy5UcmFmZmljTGF5ZXIoKTsKICAgICAgYnJlYWs7CiAgICBjYXNlICd0cmFuc2l0JzogdGhpcy5zaW5nbGVMYXllcnMudHJhbnNpdCA9IGxheWVyID0gbmV3IGdvb2dsZS5tYXBzLlRyYW5zaXRMYXllcigpOwogICAgICBicmVhazsKICAgIGNhc2UgJ2JpY3ljbGluZyc6IHRoaXMuc2luZ2xlTGF5ZXJzLmJpY3ljbGluZyA9IGxheWVyID0gbmV3IGdvb2dsZS5tYXBzLkJpY3ljbGluZ0xheWVyKCk7CiAgICAgIGJyZWFrOwogICAgY2FzZSAncGFub3JhbWlvJzoKICAgICAgICB0aGlzLnNpbmdsZUxheWVycy5wYW5vcmFtaW8gPSBsYXllciA9IG5ldyBnb29nbGUubWFwcy5wYW5vcmFtaW8uUGFub3JhbWlvTGF5ZXIoKTsKICAgICAgICBsYXllci5zZXRUYWcob3B0aW9ucy5maWx0ZXIpOwogICAgICAgIGRlbGV0ZSBvcHRpb25zLmZpbHRlcjsKCiAgICAgICAgLy9jbGljayBldmVudAogICAgICAgIGlmIChvcHRpb25zLmNsaWNrKSB7CiAgICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihsYXllciwgJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICAgICAgb3B0aW9ucy5jbGljayhldmVudCk7CiAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLmNsaWNrOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICBicmVhazsKICAgICAgY2FzZSAncGxhY2VzJzoKICAgICAgICB0aGlzLnNpbmdsZUxheWVycy5wbGFjZXMgPSBsYXllciA9IG5ldyBnb29nbGUubWFwcy5wbGFjZXMuUGxhY2VzU2VydmljZSh0aGlzLm1hcCk7CgogICAgICAgIC8vc2VhcmNoLCBuZWFyYnlTZWFyY2gsIHJhZGFyU2VhcmNoIGNhbGxiYWNrLCBCb3RoIGFyZSB0aGUgc2FtZQogICAgICAgIGlmIChvcHRpb25zLnNlYXJjaCB8fCBvcHRpb25zLm5lYXJieVNlYXJjaCB8fCBvcHRpb25zLnJhZGFyU2VhcmNoKSB7CiAgICAgICAgICB2YXIgcGxhY2VTZWFyY2hSZXF1ZXN0ICA9IHsKICAgICAgICAgICAgYm91bmRzIDogb3B0aW9ucy5ib3VuZHMgfHwgbnVsbCwKICAgICAgICAgICAga2V5d29yZCA6IG9wdGlvbnMua2V5d29yZCB8fCBudWxsLAogICAgICAgICAgICBsb2NhdGlvbiA6IG9wdGlvbnMubG9jYXRpb24gfHwgbnVsbCwKICAgICAgICAgICAgbmFtZSA6IG9wdGlvbnMubmFtZSB8fCBudWxsLAogICAgICAgICAgICByYWRpdXMgOiBvcHRpb25zLnJhZGl1cyB8fCBudWxsLAogICAgICAgICAgICByYW5rQnkgOiBvcHRpb25zLnJhbmtCeSB8fCBudWxsLAogICAgICAgICAgICB0eXBlcyA6IG9wdGlvbnMudHlwZXMgfHwgbnVsbAogICAgICAgICAgfTsKCiAgICAgICAgICBpZiAob3B0aW9ucy5yYWRhclNlYXJjaCkgewogICAgICAgICAgICBsYXllci5yYWRhclNlYXJjaChwbGFjZVNlYXJjaFJlcXVlc3QsIG9wdGlvbnMucmFkYXJTZWFyY2gpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChvcHRpb25zLnNlYXJjaCkgewogICAgICAgICAgICBsYXllci5zZWFyY2gocGxhY2VTZWFyY2hSZXF1ZXN0LCBvcHRpb25zLnNlYXJjaCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKG9wdGlvbnMubmVhcmJ5U2VhcmNoKSB7CiAgICAgICAgICAgIGxheWVyLm5lYXJieVNlYXJjaChwbGFjZVNlYXJjaFJlcXVlc3QsIG9wdGlvbnMubmVhcmJ5U2VhcmNoKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vdGV4dFNlYXJjaCBjYWxsYmFjawogICAgICAgIGlmIChvcHRpb25zLnRleHRTZWFyY2gpIHsKICAgICAgICAgIHZhciB0ZXh0U2VhcmNoUmVxdWVzdCAgPSB7CiAgICAgICAgICAgIGJvdW5kcyA6IG9wdGlvbnMuYm91bmRzIHx8IG51bGwsCiAgICAgICAgICAgIGxvY2F0aW9uIDogb3B0aW9ucy5sb2NhdGlvbiB8fCBudWxsLAogICAgICAgICAgICBxdWVyeSA6IG9wdGlvbnMucXVlcnkgfHwgbnVsbCwKICAgICAgICAgICAgcmFkaXVzIDogb3B0aW9ucy5yYWRpdXMgfHwgbnVsbAogICAgICAgICAgfTsKCiAgICAgICAgICBsYXllci50ZXh0U2VhcmNoKHRleHRTZWFyY2hSZXF1ZXN0LCBvcHRpb25zLnRleHRTZWFyY2gpOwogICAgICAgIH0KICAgICAgYnJlYWs7CiAgfQoKICBpZiAobGF5ZXIgIT09IHVuZGVmaW5lZCkgewogICAgaWYgKHR5cGVvZiBsYXllci5zZXRPcHRpb25zID09ICdmdW5jdGlvbicpIHsKICAgICAgbGF5ZXIuc2V0T3B0aW9ucyhvcHRpb25zKTsKICAgIH0KICAgIGlmICh0eXBlb2YgbGF5ZXIuc2V0TWFwID09ICdmdW5jdGlvbicpIHsKICAgICAgbGF5ZXIuc2V0TWFwKHRoaXMubWFwKTsKICAgIH0KCiAgICByZXR1cm4gbGF5ZXI7CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLnJlbW92ZUxheWVyID0gZnVuY3Rpb24obGF5ZXIpIHsKICBpZiAodHlwZW9mKGxheWVyKSA9PSAic3RyaW5nIiAmJiB0aGlzLnNpbmdsZUxheWVyc1tsYXllcl0gIT09IHVuZGVmaW5lZCkgewogICAgIHRoaXMuc2luZ2xlTGF5ZXJzW2xheWVyXS5zZXRNYXAobnVsbCk7CgogICAgIGRlbGV0ZSB0aGlzLnNpbmdsZUxheWVyc1tsYXllcl07CiAgfQogIGVsc2UgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxheWVycy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodGhpcy5sYXllcnNbaV0gPT09IGxheWVyKSB7CiAgICAgICAgdGhpcy5sYXllcnNbaV0uc2V0TWFwKG51bGwpOwogICAgICAgIHRoaXMubGF5ZXJzLnNwbGljZShpLCAxKTsKCiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICB9Cn07Cgp2YXIgdHJhdmVsTW9kZSwgdW5pdFN5c3RlbTsKCkdNYXBzLnByb3RvdHlwZS5nZXRSb3V0ZXMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgc3dpdGNoIChvcHRpb25zLnRyYXZlbE1vZGUpIHsKICAgIGNhc2UgJ2JpY3ljbGluZyc6CiAgICAgIHRyYXZlbE1vZGUgPSBnb29nbGUubWFwcy5UcmF2ZWxNb2RlLkJJQ1lDTElORzsKICAgICAgYnJlYWs7CiAgICBjYXNlICd0cmFuc2l0JzoKICAgICAgdHJhdmVsTW9kZSA9IGdvb2dsZS5tYXBzLlRyYXZlbE1vZGUuVFJBTlNJVDsKICAgICAgYnJlYWs7CiAgICBjYXNlICdkcml2aW5nJzoKICAgICAgdHJhdmVsTW9kZSA9IGdvb2dsZS5tYXBzLlRyYXZlbE1vZGUuRFJJVklORzsKICAgICAgYnJlYWs7CiAgICBkZWZhdWx0OgogICAgICB0cmF2ZWxNb2RlID0gZ29vZ2xlLm1hcHMuVHJhdmVsTW9kZS5XQUxLSU5HOwogICAgICBicmVhazsKICB9CgogIGlmIChvcHRpb25zLnVuaXRTeXN0ZW0gPT09ICdpbXBlcmlhbCcpIHsKICAgIHVuaXRTeXN0ZW0gPSBnb29nbGUubWFwcy5Vbml0U3lzdGVtLklNUEVSSUFMOwogIH0KICBlbHNlIHsKICAgIHVuaXRTeXN0ZW0gPSBnb29nbGUubWFwcy5Vbml0U3lzdGVtLk1FVFJJQzsKICB9CgogIHZhciBiYXNlX29wdGlvbnMgPSB7CiAgICAgICAgYXZvaWRIaWdod2F5czogZmFsc2UsCiAgICAgICAgYXZvaWRUb2xsczogZmFsc2UsCiAgICAgICAgb3B0aW1pemVXYXlwb2ludHM6IGZhbHNlLAogICAgICAgIHdheXBvaW50czogW10KICAgICAgfSwKICAgICAgcmVxdWVzdF9vcHRpb25zID0gIGV4dGVuZF9vYmplY3QoYmFzZV9vcHRpb25zLCBvcHRpb25zKTsKCiAgcmVxdWVzdF9vcHRpb25zLm9yaWdpbiA9IC9zdHJpbmcvLnRlc3QodHlwZW9mIG9wdGlvbnMub3JpZ2luKSA/IG9wdGlvbnMub3JpZ2luIDogbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhvcHRpb25zLm9yaWdpblswXSwgb3B0aW9ucy5vcmlnaW5bMV0pOwogIHJlcXVlc3Rfb3B0aW9ucy5kZXN0aW5hdGlvbiA9IC9zdHJpbmcvLnRlc3QodHlwZW9mIG9wdGlvbnMuZGVzdGluYXRpb24pID8gb3B0aW9ucy5kZXN0aW5hdGlvbiA6IG5ldyBnb29nbGUubWFwcy5MYXRMbmcob3B0aW9ucy5kZXN0aW5hdGlvblswXSwgb3B0aW9ucy5kZXN0aW5hdGlvblsxXSk7CiAgcmVxdWVzdF9vcHRpb25zLnRyYXZlbE1vZGUgPSB0cmF2ZWxNb2RlOwogIHJlcXVlc3Rfb3B0aW9ucy51bml0U3lzdGVtID0gdW5pdFN5c3RlbTsKCiAgZGVsZXRlIHJlcXVlc3Rfb3B0aW9ucy5jYWxsYmFjazsKICBkZWxldGUgcmVxdWVzdF9vcHRpb25zLmVycm9yOwoKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIHNlcnZpY2UgPSBuZXcgZ29vZ2xlLm1hcHMuRGlyZWN0aW9uc1NlcnZpY2UoKTsKCiAgc2VydmljZS5yb3V0ZShyZXF1ZXN0X29wdGlvbnMsIGZ1bmN0aW9uKHJlc3VsdCwgc3RhdHVzKSB7CiAgICBpZiAoc3RhdHVzID09PSBnb29nbGUubWFwcy5EaXJlY3Rpb25zU3RhdHVzLk9LKSB7CiAgICAgIGZvciAodmFyIHIgaW4gcmVzdWx0LnJvdXRlcykgewogICAgICAgIGlmIChyZXN1bHQucm91dGVzLmhhc093blByb3BlcnR5KHIpKSB7CiAgICAgICAgICBzZWxmLnJvdXRlcy5wdXNoKHJlc3VsdC5yb3V0ZXNbcl0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG9wdGlvbnMuY2FsbGJhY2spIHsKICAgICAgICBvcHRpb25zLmNhbGxiYWNrKHNlbGYucm91dGVzKTsKICAgICAgfQogICAgfQogICAgZWxzZSB7CiAgICAgIGlmIChvcHRpb25zLmVycm9yKSB7CiAgICAgICAgb3B0aW9ucy5lcnJvcihyZXN1bHQsIHN0YXR1cyk7CiAgICAgIH0KICAgIH0KICB9KTsKfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVSb3V0ZXMgPSBmdW5jdGlvbigpIHsKICB0aGlzLnJvdXRlcyA9IFtdOwp9OwoKR01hcHMucHJvdG90eXBlLmdldEVsZXZhdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IGV4dGVuZF9vYmplY3QoewogICAgbG9jYXRpb25zOiBbXSwKICAgIHBhdGggOiBmYWxzZSwKICAgIHNhbXBsZXMgOiAyNTYKICB9LCBvcHRpb25zKTsKCiAgaWYgKG9wdGlvbnMubG9jYXRpb25zLmxlbmd0aCA+IDApIHsKICAgIGlmIChvcHRpb25zLmxvY2F0aW9uc1swXS5sZW5ndGggPiAwKSB7CiAgICAgIG9wdGlvbnMubG9jYXRpb25zID0gYXJyYXlfZmxhdChhcnJheV9tYXAoW29wdGlvbnMubG9jYXRpb25zXSwgYXJyYXlUb0xhdExuZywgIGZhbHNlKSk7CiAgICB9CiAgfQoKICB2YXIgY2FsbGJhY2sgPSBvcHRpb25zLmNhbGxiYWNrOwogIGRlbGV0ZSBvcHRpb25zLmNhbGxiYWNrOwoKICB2YXIgc2VydmljZSA9IG5ldyBnb29nbGUubWFwcy5FbGV2YXRpb25TZXJ2aWNlKCk7CgogIC8vbG9jYXRpb24gcmVxdWVzdAogIGlmICghb3B0aW9ucy5wYXRoKSB7CiAgICBkZWxldGUgb3B0aW9ucy5wYXRoOwogICAgZGVsZXRlIG9wdGlvbnMuc2FtcGxlczsKCiAgICBzZXJ2aWNlLmdldEVsZXZhdGlvbkZvckxvY2F0aW9ucyhvcHRpb25zLCBmdW5jdGlvbihyZXN1bHQsIHN0YXR1cykgewogICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mKGNhbGxiYWNrKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgIGNhbGxiYWNrKHJlc3VsdCwgc3RhdHVzKTsKICAgICAgfQogICAgfSk7CiAgLy9wYXRoIHJlcXVlc3QKICB9IGVsc2UgewogICAgdmFyIHBhdGhSZXF1ZXN0ID0gewogICAgICBwYXRoIDogb3B0aW9ucy5sb2NhdGlvbnMsCiAgICAgIHNhbXBsZXMgOiBvcHRpb25zLnNhbXBsZXMKICAgIH07CgogICAgc2VydmljZS5nZXRFbGV2YXRpb25BbG9uZ1BhdGgocGF0aFJlcXVlc3QsIGZ1bmN0aW9uKHJlc3VsdCwgc3RhdHVzKSB7CiAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZihjYWxsYmFjaykgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICBjYWxsYmFjayhyZXN1bHQsIHN0YXR1cyk7CiAgICAgIH0KICAgIH0pOwogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5jbGVhblJvdXRlID0gR01hcHMucHJvdG90eXBlLnJlbW92ZVBvbHlsaW5lczsKCkdNYXBzLnByb3RvdHlwZS5kcmF3Um91dGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwoKICB0aGlzLmdldFJvdXRlcyh7CiAgICBvcmlnaW46IG9wdGlvbnMub3JpZ2luLAogICAgZGVzdGluYXRpb246IG9wdGlvbnMuZGVzdGluYXRpb24sCiAgICB0cmF2ZWxNb2RlOiBvcHRpb25zLnRyYXZlbE1vZGUsCiAgICB3YXlwb2ludHM6IG9wdGlvbnMud2F5cG9pbnRzLAogICAgdW5pdFN5c3RlbTogb3B0aW9ucy51bml0U3lzdGVtLAogICAgZXJyb3I6IG9wdGlvbnMuZXJyb3IsCiAgICBjYWxsYmFjazogZnVuY3Rpb24oZSkgewogICAgICBpZiAoZS5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIHBvbHlsaW5lX29wdGlvbnMgPSB7CiAgICAgICAgICBwYXRoOiBlW2UubGVuZ3RoIC0gMV0ub3ZlcnZpZXdfcGF0aCwKICAgICAgICAgIHN0cm9rZUNvbG9yOiBvcHRpb25zLnN0cm9rZUNvbG9yLAogICAgICAgICAgc3Ryb2tlT3BhY2l0eTogb3B0aW9ucy5zdHJva2VPcGFjaXR5LAogICAgICAgICAgc3Ryb2tlV2VpZ2h0OiBvcHRpb25zLnN0cm9rZVdlaWdodAogICAgICAgIH07CgogICAgICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KCJpY29ucyIpKSB7CiAgICAgICAgICBwb2x5bGluZV9vcHRpb25zLmljb25zID0gb3B0aW9ucy5pY29uczsKICAgICAgICB9CgogICAgICAgIHNlbGYuZHJhd1BvbHlsaW5lKHBvbHlsaW5lX29wdGlvbnMpOwoKICAgICAgICBpZiAob3B0aW9ucy5jYWxsYmFjaykgewogICAgICAgICAgb3B0aW9ucy5jYWxsYmFjayhlW2UubGVuZ3RoIC0gMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwp9OwoKR01hcHMucHJvdG90eXBlLnRyYXZlbFJvdXRlID0gZnVuY3Rpb24ob3B0aW9ucykgewogIGlmIChvcHRpb25zLm9yaWdpbiAmJiBvcHRpb25zLmRlc3RpbmF0aW9uKSB7CiAgICB0aGlzLmdldFJvdXRlcyh7CiAgICAgIG9yaWdpbjogb3B0aW9ucy5vcmlnaW4sCiAgICAgIGRlc3RpbmF0aW9uOiBvcHRpb25zLmRlc3RpbmF0aW9uLAogICAgICB0cmF2ZWxNb2RlOiBvcHRpb25zLnRyYXZlbE1vZGUsCiAgICAgIHdheXBvaW50cyA6IG9wdGlvbnMud2F5cG9pbnRzLAogICAgICB1bml0U3lzdGVtOiBvcHRpb25zLnVuaXRTeXN0ZW0sCiAgICAgIGVycm9yOiBvcHRpb25zLmVycm9yLAogICAgICBjYWxsYmFjazogZnVuY3Rpb24oZSkgewogICAgICAgIC8vc3RhcnQgY2FsbGJhY2sKICAgICAgICBpZiAoZS5sZW5ndGggPiAwICYmIG9wdGlvbnMuc3RhcnQpIHsKICAgICAgICAgIG9wdGlvbnMuc3RhcnQoZVtlLmxlbmd0aCAtIDFdKTsKICAgICAgICB9CgogICAgICAgIC8vc3RlcCBjYWxsYmFjawogICAgICAgIGlmIChlLmxlbmd0aCA+IDAgJiYgb3B0aW9ucy5zdGVwKSB7CiAgICAgICAgICB2YXIgcm91dGUgPSBlW2UubGVuZ3RoIC0gMV07CiAgICAgICAgICBpZiAocm91dGUubGVncy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIHZhciBzdGVwcyA9IHJvdXRlLmxlZ3NbMF0uc3RlcHM7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBzdGVwOyBzdGVwID0gc3RlcHNbaV07IGkrKykgewogICAgICAgICAgICAgIHN0ZXAuc3RlcF9udW1iZXIgPSBpOwogICAgICAgICAgICAgIG9wdGlvbnMuc3RlcChzdGVwLCAocm91dGUubGVnc1swXS5zdGVwcy5sZW5ndGggLSAxKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vZW5kIGNhbGxiYWNrCiAgICAgICAgaWYgKGUubGVuZ3RoID4gMCAmJiBvcHRpb25zLmVuZCkgewogICAgICAgICAgIG9wdGlvbnMuZW5kKGVbZS5sZW5ndGggLSAxXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CiAgZWxzZSBpZiAob3B0aW9ucy5yb3V0ZSkgewogICAgaWYgKG9wdGlvbnMucm91dGUubGVncy5sZW5ndGggPiAwKSB7CiAgICAgIHZhciBzdGVwcyA9IG9wdGlvbnMucm91dGUubGVnc1swXS5zdGVwczsKICAgICAgZm9yICh2YXIgaSA9IDAsIHN0ZXA7IHN0ZXAgPSBzdGVwc1tpXTsgaSsrKSB7CiAgICAgICAgc3RlcC5zdGVwX251bWJlciA9IGk7CiAgICAgICAgb3B0aW9ucy5zdGVwKHN0ZXApOwogICAgICB9CiAgICB9CiAgfQp9OwoKR01hcHMucHJvdG90eXBlLmRyYXdTdGVwcGVkUm91dGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwoKICBpZiAob3B0aW9ucy5vcmlnaW4gJiYgb3B0aW9ucy5kZXN0aW5hdGlvbikgewogICAgdGhpcy5nZXRSb3V0ZXMoewogICAgICBvcmlnaW46IG9wdGlvbnMub3JpZ2luLAogICAgICBkZXN0aW5hdGlvbjogb3B0aW9ucy5kZXN0aW5hdGlvbiwKICAgICAgdHJhdmVsTW9kZTogb3B0aW9ucy50cmF2ZWxNb2RlLAogICAgICB3YXlwb2ludHMgOiBvcHRpb25zLndheXBvaW50cywKICAgICAgZXJyb3I6IG9wdGlvbnMuZXJyb3IsCiAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbihlKSB7CiAgICAgICAgLy9zdGFydCBjYWxsYmFjawogICAgICAgIGlmIChlLmxlbmd0aCA+IDAgJiYgb3B0aW9ucy5zdGFydCkgewogICAgICAgICAgb3B0aW9ucy5zdGFydChlW2UubGVuZ3RoIC0gMV0pOwogICAgICAgIH0KCiAgICAgICAgLy9zdGVwIGNhbGxiYWNrCiAgICAgICAgaWYgKGUubGVuZ3RoID4gMCAmJiBvcHRpb25zLnN0ZXApIHsKICAgICAgICAgIHZhciByb3V0ZSA9IGVbZS5sZW5ndGggLSAxXTsKICAgICAgICAgIGlmIChyb3V0ZS5sZWdzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIHN0ZXBzID0gcm91dGUubGVnc1swXS5zdGVwczsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHN0ZXA7IHN0ZXAgPSBzdGVwc1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgc3RlcC5zdGVwX251bWJlciA9IGk7CiAgICAgICAgICAgICAgdmFyIHBvbHlsaW5lX29wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICBwYXRoOiBzdGVwLnBhdGgsCiAgICAgICAgICAgICAgICBzdHJva2VDb2xvcjogb3B0aW9ucy5zdHJva2VDb2xvciwKICAgICAgICAgICAgICAgIHN0cm9rZU9wYWNpdHk6IG9wdGlvbnMuc3Ryb2tlT3BhY2l0eSwKICAgICAgICAgICAgICAgIHN0cm9rZVdlaWdodDogb3B0aW9ucy5zdHJva2VXZWlnaHQKICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgiaWNvbnMiKSkgewogICAgICAgICAgICAgICAgcG9seWxpbmVfb3B0aW9ucy5pY29ucyA9IG9wdGlvbnMuaWNvbnM7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBzZWxmLmRyYXdQb2x5bGluZShwb2x5bGluZV9vcHRpb25zKTsKICAgICAgICAgICAgICBvcHRpb25zLnN0ZXAoc3RlcCwgKHJvdXRlLmxlZ3NbMF0uc3RlcHMubGVuZ3RoIC0gMSkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvL2VuZCBjYWxsYmFjawogICAgICAgIGlmIChlLmxlbmd0aCA+IDAgJiYgb3B0aW9ucy5lbmQpIHsKICAgICAgICAgICBvcHRpb25zLmVuZChlW2UubGVuZ3RoIC0gMV0pOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIGVsc2UgaWYgKG9wdGlvbnMucm91dGUpIHsKICAgIGlmIChvcHRpb25zLnJvdXRlLmxlZ3MubGVuZ3RoID4gMCkgewogICAgICB2YXIgc3RlcHMgPSBvcHRpb25zLnJvdXRlLmxlZ3NbMF0uc3RlcHM7CiAgICAgIGZvciAodmFyIGkgPSAwLCBzdGVwOyBzdGVwID0gc3RlcHNbaV07IGkrKykgewogICAgICAgIHN0ZXAuc3RlcF9udW1iZXIgPSBpOwogICAgICAgIHZhciBwb2x5bGluZV9vcHRpb25zID0gewogICAgICAgICAgcGF0aDogc3RlcC5wYXRoLAogICAgICAgICAgc3Ryb2tlQ29sb3I6IG9wdGlvbnMuc3Ryb2tlQ29sb3IsCiAgICAgICAgICBzdHJva2VPcGFjaXR5OiBvcHRpb25zLnN0cm9rZU9wYWNpdHksCiAgICAgICAgICBzdHJva2VXZWlnaHQ6IG9wdGlvbnMuc3Ryb2tlV2VpZ2h0CiAgICAgICAgfTsKCiAgICAgICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoImljb25zIikpIHsKICAgICAgICAgIHBvbHlsaW5lX29wdGlvbnMuaWNvbnMgPSBvcHRpb25zLmljb25zOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5kcmF3UG9seWxpbmUocG9seWxpbmVfb3B0aW9ucyk7CiAgICAgICAgb3B0aW9ucy5zdGVwKHN0ZXApOwogICAgICB9CiAgICB9CiAgfQp9OwoKR01hcHMuUm91dGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdGhpcy5vcmlnaW4gPSBvcHRpb25zLm9yaWdpbjsKICB0aGlzLmRlc3RpbmF0aW9uID0gb3B0aW9ucy5kZXN0aW5hdGlvbjsKICB0aGlzLndheXBvaW50cyA9IG9wdGlvbnMud2F5cG9pbnRzOwoKICB0aGlzLm1hcCA9IG9wdGlvbnMubWFwOwogIHRoaXMucm91dGUgPSBvcHRpb25zLnJvdXRlOwogIHRoaXMuc3RlcF9jb3VudCA9IDA7CiAgdGhpcy5zdGVwcyA9IHRoaXMucm91dGUubGVnc1swXS5zdGVwczsKICB0aGlzLnN0ZXBzX2xlbmd0aCA9IHRoaXMuc3RlcHMubGVuZ3RoOwoKICB2YXIgcG9seWxpbmVfb3B0aW9ucyA9IHsKICAgIHBhdGg6IG5ldyBnb29nbGUubWFwcy5NVkNBcnJheSgpLAogICAgc3Ryb2tlQ29sb3I6IG9wdGlvbnMuc3Ryb2tlQ29sb3IsCiAgICBzdHJva2VPcGFjaXR5OiBvcHRpb25zLnN0cm9rZU9wYWNpdHksCiAgICBzdHJva2VXZWlnaHQ6IG9wdGlvbnMuc3Ryb2tlV2VpZ2h0CiAgfTsKCiAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkoImljb25zIikpIHsKICAgIHBvbHlsaW5lX29wdGlvbnMuaWNvbnMgPSBvcHRpb25zLmljb25zOwogIH0KCiAgdGhpcy5wb2x5bGluZSA9IHRoaXMubWFwLmRyYXdQb2x5bGluZShwb2x5bGluZV9vcHRpb25zKS5nZXRQYXRoKCk7Cn07CgpHTWFwcy5Sb3V0ZS5wcm90b3R5cGUuZ2V0Um91dGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHNlbGYgPSB0aGlzOwoKICB0aGlzLm1hcC5nZXRSb3V0ZXMoewogICAgb3JpZ2luIDogdGhpcy5vcmlnaW4sCiAgICBkZXN0aW5hdGlvbiA6IHRoaXMuZGVzdGluYXRpb24sCiAgICB0cmF2ZWxNb2RlIDogb3B0aW9ucy50cmF2ZWxNb2RlLAogICAgd2F5cG9pbnRzIDogdGhpcy53YXlwb2ludHMgfHwgW10sCiAgICBlcnJvcjogb3B0aW9ucy5lcnJvciwKICAgIGNhbGxiYWNrIDogZnVuY3Rpb24oKSB7CiAgICAgIHNlbGYucm91dGUgPSBlWzBdOwoKICAgICAgaWYgKG9wdGlvbnMuY2FsbGJhY2spIHsKICAgICAgICBvcHRpb25zLmNhbGxiYWNrLmNhbGwoc2VsZik7CiAgICAgIH0KICAgIH0KICB9KTsKfTsKCkdNYXBzLlJvdXRlLnByb3RvdHlwZS5iYWNrID0gZnVuY3Rpb24oKSB7CiAgaWYgKHRoaXMuc3RlcF9jb3VudCA+IDApIHsKICAgIHRoaXMuc3RlcF9jb3VudC0tOwogICAgdmFyIHBhdGggPSB0aGlzLnJvdXRlLmxlZ3NbMF0uc3RlcHNbdGhpcy5zdGVwX2NvdW50XS5wYXRoOwoKICAgIGZvciAodmFyIHAgaW4gcGF0aCl7CiAgICAgIGlmIChwYXRoLmhhc093blByb3BlcnR5KHApKXsKICAgICAgICB0aGlzLnBvbHlsaW5lLnBvcCgpOwogICAgICB9CiAgICB9CiAgfQp9OwoKR01hcHMuUm91dGUucHJvdG90eXBlLmZvcndhcmQgPSBmdW5jdGlvbigpIHsKICBpZiAodGhpcy5zdGVwX2NvdW50IDwgdGhpcy5zdGVwc19sZW5ndGgpIHsKICAgIHZhciBwYXRoID0gdGhpcy5yb3V0ZS5sZWdzWzBdLnN0ZXBzW3RoaXMuc3RlcF9jb3VudF0ucGF0aDsKCiAgICBmb3IgKHZhciBwIGluIHBhdGgpewogICAgICBpZiAocGF0aC5oYXNPd25Qcm9wZXJ0eShwKSl7CiAgICAgICAgdGhpcy5wb2x5bGluZS5wdXNoKHBhdGhbcF0pOwogICAgICB9CiAgICB9CiAgICB0aGlzLnN0ZXBfY291bnQrKzsKICB9Cn07CgpHTWFwcy5wcm90b3R5cGUuY2hlY2tHZW9mZW5jZSA9IGZ1bmN0aW9uKGxhdCwgbG5nLCBmZW5jZSkgewogIHJldHVybiBmZW5jZS5jb250YWluc0xhdExuZyhuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKGxhdCwgbG5nKSk7Cn07CgpHTWFwcy5wcm90b3R5cGUuY2hlY2tNYXJrZXJHZW9mZW5jZSA9IGZ1bmN0aW9uKG1hcmtlciwgb3V0c2lkZV9jYWxsYmFjaykgewogIGlmIChtYXJrZXIuZmVuY2VzKSB7CiAgICBmb3IgKHZhciBpID0gMCwgZmVuY2U7IGZlbmNlID0gbWFya2VyLmZlbmNlc1tpXTsgaSsrKSB7CiAgICAgIHZhciBwb3MgPSBtYXJrZXIuZ2V0UG9zaXRpb24oKTsKICAgICAgaWYgKCF0aGlzLmNoZWNrR2VvZmVuY2UocG9zLmxhdCgpLCBwb3MubG5nKCksIGZlbmNlKSkgewogICAgICAgIG91dHNpZGVfY2FsbGJhY2sobWFya2VyLCBmZW5jZSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgpHTWFwcy5wcm90b3R5cGUudG9JbWFnZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgb3B0aW9ucyA9IG9wdGlvbnMgfHwge30sCiAgICAgIHN0YXRpY19tYXBfb3B0aW9ucyA9IHt9OwoKICBzdGF0aWNfbWFwX29wdGlvbnNbJ3NpemUnXSA9IG9wdGlvbnNbJ3NpemUnXSB8fCBbdGhpcy5lbC5jbGllbnRXaWR0aCwgdGhpcy5lbC5jbGllbnRIZWlnaHRdOwogIHN0YXRpY19tYXBfb3B0aW9uc1snbGF0J10gPSB0aGlzLmdldENlbnRlcigpLmxhdCgpOwogIHN0YXRpY19tYXBfb3B0aW9uc1snbG5nJ10gPSB0aGlzLmdldENlbnRlcigpLmxuZygpOwoKICBpZiAodGhpcy5tYXJrZXJzLmxlbmd0aCA+IDApIHsKICAgIHN0YXRpY19tYXBfb3B0aW9uc1snbWFya2VycyddID0gW107CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLm1hcmtlcnMubGVuZ3RoOyBpKyspIHsKICAgICAgc3RhdGljX21hcF9vcHRpb25zWydtYXJrZXJzJ10ucHVzaCh7CiAgICAgICAgbGF0OiB0aGlzLm1hcmtlcnNbaV0uZ2V0UG9zaXRpb24oKS5sYXQoKSwKICAgICAgICBsbmc6IHRoaXMubWFya2Vyc1tpXS5nZXRQb3NpdGlvbigpLmxuZygpCiAgICAgIH0pOwogICAgfQogIH0KCiAgaWYgKHRoaXMucG9seWxpbmVzLmxlbmd0aCA+IDApIHsKICAgIHZhciBwb2x5bGluZSA9IHRoaXMucG9seWxpbmVzWzBdOwoKICAgIHN0YXRpY19tYXBfb3B0aW9uc1sncG9seWxpbmUnXSA9IHt9OwogICAgc3RhdGljX21hcF9vcHRpb25zWydwb2x5bGluZSddWydwYXRoJ10gPSBnb29nbGUubWFwcy5nZW9tZXRyeS5lbmNvZGluZy5lbmNvZGVQYXRoKHBvbHlsaW5lLmdldFBhdGgoKSk7CiAgICBzdGF0aWNfbWFwX29wdGlvbnNbJ3BvbHlsaW5lJ11bJ3N0cm9rZUNvbG9yJ10gPSBwb2x5bGluZS5zdHJva2VDb2xvcgogICAgc3RhdGljX21hcF9vcHRpb25zWydwb2x5bGluZSddWydzdHJva2VPcGFjaXR5J10gPSBwb2x5bGluZS5zdHJva2VPcGFjaXR5CiAgICBzdGF0aWNfbWFwX29wdGlvbnNbJ3BvbHlsaW5lJ11bJ3N0cm9rZVdlaWdodCddID0gcG9seWxpbmUuc3Ryb2tlV2VpZ2h0CiAgfQoKICByZXR1cm4gR01hcHMuc3RhdGljTWFwVVJMKHN0YXRpY19tYXBfb3B0aW9ucyk7Cn07CgpHTWFwcy5zdGF0aWNNYXBVUkwgPSBmdW5jdGlvbihvcHRpb25zKXsKICB2YXIgcGFyYW1ldGVycyA9IFtdLAogICAgICBkYXRhLAogICAgICBzdGF0aWNfcm9vdCA9IChsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2ZpbGU6JyA/ICdodHRwOicgOiBsb2NhdGlvbi5wcm90b2NvbCApICsgJy8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9zdGF0aWNtYXAnOwoKICBpZiAob3B0aW9ucy51cmwpIHsKICAgIHN0YXRpY19yb290ID0gb3B0aW9ucy51cmw7CiAgICBkZWxldGUgb3B0aW9ucy51cmw7CiAgfQoKICBzdGF0aWNfcm9vdCArPSAnPyc7CgogIHZhciBtYXJrZXJzID0gb3B0aW9ucy5tYXJrZXJzOwoKICBkZWxldGUgb3B0aW9ucy5tYXJrZXJzOwoKICBpZiAoIW1hcmtlcnMgJiYgb3B0aW9ucy5tYXJrZXIpIHsKICAgIG1hcmtlcnMgPSBbb3B0aW9ucy5tYXJrZXJdOwogICAgZGVsZXRlIG9wdGlvbnMubWFya2VyOwogIH0KCiAgdmFyIHN0eWxlcyA9IG9wdGlvbnMuc3R5bGVzOwoKICBkZWxldGUgb3B0aW9ucy5zdHlsZXM7CgogIHZhciBwb2x5bGluZSA9IG9wdGlvbnMucG9seWxpbmU7CiAgZGVsZXRlIG9wdGlvbnMucG9seWxpbmU7CgogIC8qKiBNYXAgb3B0aW9ucyAqKi8KICBpZiAob3B0aW9ucy5jZW50ZXIpIHsKICAgIHBhcmFtZXRlcnMucHVzaCgnY2VudGVyPScgKyBvcHRpb25zLmNlbnRlcik7CiAgICBkZWxldGUgb3B0aW9ucy5jZW50ZXI7CiAgfQogIGVsc2UgaWYgKG9wdGlvbnMuYWRkcmVzcykgewogICAgcGFyYW1ldGVycy5wdXNoKCdjZW50ZXI9JyArIG9wdGlvbnMuYWRkcmVzcyk7CiAgICBkZWxldGUgb3B0aW9ucy5hZGRyZXNzOwogIH0KICBlbHNlIGlmIChvcHRpb25zLmxhdCkgewogICAgcGFyYW1ldGVycy5wdXNoKFsnY2VudGVyPScsIG9wdGlvbnMubGF0LCAnLCcsIG9wdGlvbnMubG5nXS5qb2luKCcnKSk7CiAgICBkZWxldGUgb3B0aW9ucy5sYXQ7CiAgICBkZWxldGUgb3B0aW9ucy5sbmc7CiAgfQogIGVsc2UgaWYgKG9wdGlvbnMudmlzaWJsZSkgewogICAgdmFyIHZpc2libGUgPSBlbmNvZGVVUkkob3B0aW9ucy52aXNpYmxlLmpvaW4oJ3wnKSk7CiAgICBwYXJhbWV0ZXJzLnB1c2goJ3Zpc2libGU9JyArIHZpc2libGUpOwogIH0KCiAgdmFyIHNpemUgPSBvcHRpb25zLnNpemU7CiAgaWYgKHNpemUpIHsKICAgIGlmIChzaXplLmpvaW4pIHsKICAgICAgc2l6ZSA9IHNpemUuam9pbigneCcpOwogICAgfQogICAgZGVsZXRlIG9wdGlvbnMuc2l6ZTsKICB9CiAgZWxzZSB7CiAgICBzaXplID0gJzYzMHgzMDAnOwogIH0KICBwYXJhbWV0ZXJzLnB1c2goJ3NpemU9JyArIHNpemUpOwoKICBpZiAoIW9wdGlvbnMuem9vbSAmJiBvcHRpb25zLnpvb20gIT09IGZhbHNlKSB7CiAgICBvcHRpb25zLnpvb20gPSAxNTsKICB9CgogIHZhciBzZW5zb3IgPSBvcHRpb25zLmhhc093blByb3BlcnR5KCdzZW5zb3InKSA/ICEhb3B0aW9ucy5zZW5zb3IgOiB0cnVlOwogIGRlbGV0ZSBvcHRpb25zLnNlbnNvcjsKICBwYXJhbWV0ZXJzLnB1c2goJ3NlbnNvcj0nICsgc2Vuc29yKTsKCiAgZm9yICh2YXIgcGFyYW0gaW4gb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuaGFzT3duUHJvcGVydHkocGFyYW0pKSB7CiAgICAgIHBhcmFtZXRlcnMucHVzaChwYXJhbSArICc9JyArIG9wdGlvbnNbcGFyYW1dKTsKICAgIH0KICB9CgogIC8qKiBNYXJrZXJzICoqLwogIGlmIChtYXJrZXJzKSB7CiAgICB2YXIgbWFya2VyLCBsb2M7CgogICAgZm9yICh2YXIgaSA9IDA7IGRhdGEgPSBtYXJrZXJzW2ldOyBpKyspIHsKICAgICAgbWFya2VyID0gW107CgogICAgICBpZiAoZGF0YS5zaXplICYmIGRhdGEuc2l6ZSAhPT0gJ25vcm1hbCcpIHsKICAgICAgICBtYXJrZXIucHVzaCgnc2l6ZTonICsgZGF0YS5zaXplKTsKICAgICAgICBkZWxldGUgZGF0YS5zaXplOwogICAgICB9CiAgICAgIGVsc2UgaWYgKGRhdGEuaWNvbikgewogICAgICAgIG1hcmtlci5wdXNoKCdpY29uOicgKyBlbmNvZGVVUkkoZGF0YS5pY29uKSk7CiAgICAgICAgZGVsZXRlIGRhdGEuaWNvbjsKICAgICAgfQoKICAgICAgaWYgKGRhdGEuY29sb3IpIHsKICAgICAgICBtYXJrZXIucHVzaCgnY29sb3I6JyArIGRhdGEuY29sb3IucmVwbGFjZSgnIycsICcweCcpKTsKICAgICAgICBkZWxldGUgZGF0YS5jb2xvcjsKICAgICAgfQoKICAgICAgaWYgKGRhdGEubGFiZWwpIHsKICAgICAgICBtYXJrZXIucHVzaCgnbGFiZWw6JyArIGRhdGEubGFiZWxbMF0udG9VcHBlckNhc2UoKSk7CiAgICAgICAgZGVsZXRlIGRhdGEubGFiZWw7CiAgICAgIH0KCiAgICAgIGxvYyA9IChkYXRhLmFkZHJlc3MgPyBkYXRhLmFkZHJlc3MgOiBkYXRhLmxhdCArICcsJyArIGRhdGEubG5nKTsKICAgICAgZGVsZXRlIGRhdGEuYWRkcmVzczsKICAgICAgZGVsZXRlIGRhdGEubGF0OwogICAgICBkZWxldGUgZGF0YS5sbmc7CgogICAgICBmb3IodmFyIHBhcmFtIGluIGRhdGEpewogICAgICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KHBhcmFtKSkgewogICAgICAgICAgbWFya2VyLnB1c2gocGFyYW0gKyAnOicgKyBkYXRhW3BhcmFtXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAobWFya2VyLmxlbmd0aCB8fCBpID09PSAwKSB7CiAgICAgICAgbWFya2VyLnB1c2gobG9jKTsKICAgICAgICBtYXJrZXIgPSBtYXJrZXIuam9pbignfCcpOwogICAgICAgIHBhcmFtZXRlcnMucHVzaCgnbWFya2Vycz0nICsgZW5jb2RlVVJJKG1hcmtlcikpOwogICAgICB9CiAgICAgIC8vIE5ldyBtYXJrZXIgd2l0aG91dCBzdHlsZXMKICAgICAgZWxzZSB7CiAgICAgICAgbWFya2VyID0gcGFyYW1ldGVycy5wb3AoKSArIGVuY29kZVVSSSgnfCcgKyBsb2MpOwogICAgICAgIHBhcmFtZXRlcnMucHVzaChtYXJrZXIpOwogICAgICB9CiAgICB9CiAgfQoKICAvKiogTWFwIFN0eWxlcyAqKi8KICBpZiAoc3R5bGVzKSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0eWxlcy5sZW5ndGg7IGkrKykgewogICAgICB2YXIgc3R5bGVSdWxlID0gW107CiAgICAgIGlmIChzdHlsZXNbaV0uZmVhdHVyZVR5cGUpewogICAgICAgIHN0eWxlUnVsZS5wdXNoKCdmZWF0dXJlOicgKyBzdHlsZXNbaV0uZmVhdHVyZVR5cGUudG9Mb3dlckNhc2UoKSk7CiAgICAgIH0KCiAgICAgIGlmIChzdHlsZXNbaV0uZWxlbWVudFR5cGUpIHsKICAgICAgICBzdHlsZVJ1bGUucHVzaCgnZWxlbWVudDonICsgc3R5bGVzW2ldLmVsZW1lbnRUeXBlLnRvTG93ZXJDYXNlKCkpOwogICAgICB9CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHN0eWxlc1tpXS5zdHlsZXJzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgZm9yICh2YXIgcCBpbiBzdHlsZXNbaV0uc3R5bGVyc1tqXSkgewogICAgICAgICAgdmFyIHJ1bGVBcmcgPSBzdHlsZXNbaV0uc3R5bGVyc1tqXVtwXTsKICAgICAgICAgIGlmIChwID09ICdodWUnIHx8IHAgPT0gJ2NvbG9yJykgewogICAgICAgICAgICBydWxlQXJnID0gJzB4JyArIHJ1bGVBcmcuc3Vic3RyaW5nKDEpOwogICAgICAgICAgfQogICAgICAgICAgc3R5bGVSdWxlLnB1c2gocCArICc6JyArIHJ1bGVBcmcpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHJ1bGUgPSBzdHlsZVJ1bGUuam9pbignfCcpOwogICAgICBpZiAocnVsZSAhPSAnJykgewogICAgICAgIHBhcmFtZXRlcnMucHVzaCgnc3R5bGU9JyArIHJ1bGUpOwogICAgICB9CiAgICB9CiAgfQoKICAvKiogUG9seWxpbmVzICoqLwogIGZ1bmN0aW9uIHBhcnNlQ29sb3IoY29sb3IsIG9wYWNpdHkpIHsKICAgIGlmIChjb2xvclswXSA9PT0gJyMnKXsKICAgICAgY29sb3IgPSBjb2xvci5yZXBsYWNlKCcjJywgJzB4Jyk7CgogICAgICBpZiAob3BhY2l0eSkgewogICAgICAgIG9wYWNpdHkgPSBwYXJzZUZsb2F0KG9wYWNpdHkpOwogICAgICAgIG9wYWNpdHkgPSBNYXRoLm1pbigxLCBNYXRoLm1heChvcGFjaXR5LCAwKSk7CiAgICAgICAgaWYgKG9wYWNpdHkgPT09IDApIHsKICAgICAgICAgIHJldHVybiAnMHgwMDAwMDAwMCc7CiAgICAgICAgfQogICAgICAgIG9wYWNpdHkgPSAob3BhY2l0eSAqIDI1NSkudG9TdHJpbmcoMTYpOwogICAgICAgIGlmIChvcGFjaXR5Lmxlbmd0aCA9PT0gMSkgewogICAgICAgICAgb3BhY2l0eSArPSBvcGFjaXR5OwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvci5zbGljZSgwLDgpICsgb3BhY2l0eTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIGNvbG9yOwogIH0KCiAgaWYgKHBvbHlsaW5lKSB7CiAgICBkYXRhID0gcG9seWxpbmU7CiAgICBwb2x5bGluZSA9IFtdOwoKICAgIGlmIChkYXRhLnN0cm9rZVdlaWdodCkgewogICAgICBwb2x5bGluZS5wdXNoKCd3ZWlnaHQ6JyArIHBhcnNlSW50KGRhdGEuc3Ryb2tlV2VpZ2h0LCAxMCkpOwogICAgfQoKICAgIGlmIChkYXRhLnN0cm9rZUNvbG9yKSB7CiAgICAgIHZhciBjb2xvciA9IHBhcnNlQ29sb3IoZGF0YS5zdHJva2VDb2xvciwgZGF0YS5zdHJva2VPcGFjaXR5KTsKICAgICAgcG9seWxpbmUucHVzaCgnY29sb3I6JyArIGNvbG9yKTsKICAgIH0KCiAgICBpZiAoZGF0YS5maWxsQ29sb3IpIHsKICAgICAgdmFyIGZpbGxjb2xvciA9IHBhcnNlQ29sb3IoZGF0YS5maWxsQ29sb3IsIGRhdGEuZmlsbE9wYWNpdHkpOwogICAgICBwb2x5bGluZS5wdXNoKCdmaWxsY29sb3I6JyArIGZpbGxjb2xvcik7CiAgICB9CgogICAgdmFyIHBhdGggPSBkYXRhLnBhdGg7CiAgICBpZiAocGF0aC5qb2luKSB7CiAgICAgIGZvciAodmFyIGo9MCwgcG9zOyBwb3M9cGF0aFtqXTsgaisrKSB7CiAgICAgICAgcG9seWxpbmUucHVzaChwb3Muam9pbignLCcpKTsKICAgICAgfQogICAgfQogICAgZWxzZSB7CiAgICAgIHBvbHlsaW5lLnB1c2goJ2VuYzonICsgcGF0aCk7CiAgICB9CgogICAgcG9seWxpbmUgPSBwb2x5bGluZS5qb2luKCd8Jyk7CiAgICBwYXJhbWV0ZXJzLnB1c2goJ3BhdGg9JyArIGVuY29kZVVSSShwb2x5bGluZSkpOwogIH0KCiAgLyoqIFJldGluYSBzdXBwb3J0ICoqLwogIHZhciBkcGkgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxOwogIHBhcmFtZXRlcnMucHVzaCgnc2NhbGU9JyArIGRwaSk7CgogIHBhcmFtZXRlcnMgPSBwYXJhbWV0ZXJzLmpvaW4oJyYnKTsKICByZXR1cm4gc3RhdGljX3Jvb3QgKyBwYXJhbWV0ZXJzOwp9OwoKR01hcHMucHJvdG90eXBlLmFkZE1hcFR5cGUgPSBmdW5jdGlvbihtYXBUeXBlSWQsIG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgiZ2V0VGlsZVVybCIpICYmIHR5cGVvZihvcHRpb25zWyJnZXRUaWxlVXJsIl0pID09ICJmdW5jdGlvbiIpIHsKICAgIG9wdGlvbnMudGlsZVNpemUgPSBvcHRpb25zLnRpbGVTaXplIHx8IG5ldyBnb29nbGUubWFwcy5TaXplKDI1NiwgMjU2KTsKCiAgICB2YXIgbWFwVHlwZSA9IG5ldyBnb29nbGUubWFwcy5JbWFnZU1hcFR5cGUob3B0aW9ucyk7CgogICAgdGhpcy5tYXAubWFwVHlwZXMuc2V0KG1hcFR5cGVJZCwgbWFwVHlwZSk7CiAgfQogIGVsc2UgewogICAgdGhyb3cgIidnZXRUaWxlVXJsJyBmdW5jdGlvbiByZXF1aXJlZC4iOwogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5hZGRPdmVybGF5TWFwVHlwZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgiZ2V0VGlsZSIpICYmIHR5cGVvZihvcHRpb25zWyJnZXRUaWxlIl0pID09ICJmdW5jdGlvbiIpIHsKICAgIHZhciBvdmVybGF5TWFwVHlwZUluZGV4ID0gb3B0aW9ucy5pbmRleDsKCiAgICBkZWxldGUgb3B0aW9ucy5pbmRleDsKCiAgICB0aGlzLm1hcC5vdmVybGF5TWFwVHlwZXMuaW5zZXJ0QXQob3ZlcmxheU1hcFR5cGVJbmRleCwgb3B0aW9ucyk7CiAgfQogIGVsc2UgewogICAgdGhyb3cgIidnZXRUaWxlJyBmdW5jdGlvbiByZXF1aXJlZC4iOwogIH0KfTsKCkdNYXBzLnByb3RvdHlwZS5yZW1vdmVPdmVybGF5TWFwVHlwZSA9IGZ1bmN0aW9uKG92ZXJsYXlNYXBUeXBlSW5kZXgpIHsKICB0aGlzLm1hcC5vdmVybGF5TWFwVHlwZXMucmVtb3ZlQXQob3ZlcmxheU1hcFR5cGVJbmRleCk7Cn07CgpHTWFwcy5wcm90b3R5cGUuYWRkU3R5bGUgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIHN0eWxlZE1hcFR5cGUgPSBuZXcgZ29vZ2xlLm1hcHMuU3R5bGVkTWFwVHlwZShvcHRpb25zLnN0eWxlcywgeyBuYW1lOiBvcHRpb25zLnN0eWxlZE1hcE5hbWUgfSk7CgogIHRoaXMubWFwLm1hcFR5cGVzLnNldChvcHRpb25zLm1hcFR5cGVJZCwgc3R5bGVkTWFwVHlwZSk7Cn07CgpHTWFwcy5wcm90b3R5cGUuc2V0U3R5bGUgPSBmdW5jdGlvbihtYXBUeXBlSWQpIHsKICB0aGlzLm1hcC5zZXRNYXBUeXBlSWQobWFwVHlwZUlkKTsKfTsKCkdNYXBzLnByb3RvdHlwZS5jcmVhdGVQYW5vcmFtYSA9IGZ1bmN0aW9uKHN0cmVldHZpZXdfb3B0aW9ucykgewogIGlmICghc3RyZWV0dmlld19vcHRpb25zLmhhc093blByb3BlcnR5KCdsYXQnKSB8fCAhc3RyZWV0dmlld19vcHRpb25zLmhhc093blByb3BlcnR5KCdsbmcnKSkgewogICAgc3RyZWV0dmlld19vcHRpb25zLmxhdCA9IHRoaXMuZ2V0Q2VudGVyKCkubGF0KCk7CiAgICBzdHJlZXR2aWV3X29wdGlvbnMubG5nID0gdGhpcy5nZXRDZW50ZXIoKS5sbmcoKTsKICB9CgogIHRoaXMucGFub3JhbWEgPSBHTWFwcy5jcmVhdGVQYW5vcmFtYShzdHJlZXR2aWV3X29wdGlvbnMpOwoKICB0aGlzLm1hcC5zZXRTdHJlZXRWaWV3KHRoaXMucGFub3JhbWEpOwoKICByZXR1cm4gdGhpcy5wYW5vcmFtYTsKfTsKCkdNYXBzLmNyZWF0ZVBhbm9yYW1hID0gZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciBlbCA9IGdldEVsZW1lbnRCeUlkKG9wdGlvbnMuZWwsIG9wdGlvbnMuY29udGV4dCk7CgogIG9wdGlvbnMucG9zaXRpb24gPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKG9wdGlvbnMubGF0LCBvcHRpb25zLmxuZyk7CgogIGRlbGV0ZSBvcHRpb25zLmVsOwogIGRlbGV0ZSBvcHRpb25zLmNvbnRleHQ7CiAgZGVsZXRlIG9wdGlvbnMubGF0OwogIGRlbGV0ZSBvcHRpb25zLmxuZzsKCiAgdmFyIHN0cmVldHZpZXdfZXZlbnRzID0gWydjbG9zZWNsaWNrJywgJ2xpbmtzX2NoYW5nZWQnLCAncGFub19jaGFuZ2VkJywgJ3Bvc2l0aW9uX2NoYW5nZWQnLCAncG92X2NoYW5nZWQnLCAncmVzaXplJywgJ3Zpc2libGVfY2hhbmdlZCddLAogICAgICBzdHJlZXR2aWV3X29wdGlvbnMgPSBleHRlbmRfb2JqZWN0KHt2aXNpYmxlIDogdHJ1ZX0sIG9wdGlvbnMpOwoKICBmb3IgKHZhciBpID0gMDsgaSA8IHN0cmVldHZpZXdfZXZlbnRzLmxlbmd0aDsgaSsrKSB7CiAgICBkZWxldGUgc3RyZWV0dmlld19vcHRpb25zW3N0cmVldHZpZXdfZXZlbnRzW2ldXTsKICB9CgogIHZhciBwYW5vcmFtYSA9IG5ldyBnb29nbGUubWFwcy5TdHJlZXRWaWV3UGFub3JhbWEoZWwsIHN0cmVldHZpZXdfb3B0aW9ucyk7CgogIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyZWV0dmlld19ldmVudHMubGVuZ3RoOyBpKyspIHsKICAgIChmdW5jdGlvbihvYmplY3QsIG5hbWUpIHsKICAgICAgaWYgKG9wdGlvbnNbbmFtZV0pIHsKICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihvYmplY3QsIG5hbWUsIGZ1bmN0aW9uKCl7CiAgICAgICAgICBvcHRpb25zW25hbWVdLmFwcGx5KHRoaXMpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KShwYW5vcmFtYSwgc3RyZWV0dmlld19ldmVudHNbaV0pOwogIH0KCiAgcmV0dXJuIHBhbm9yYW1hOwp9OwoKR01hcHMucHJvdG90eXBlLm9uID0gZnVuY3Rpb24oZXZlbnRfbmFtZSwgaGFuZGxlcikgewogIHJldHVybiBHTWFwcy5vbihldmVudF9uYW1lLCB0aGlzLCBoYW5kbGVyKTsKfTsKCkdNYXBzLnByb3RvdHlwZS5vZmYgPSBmdW5jdGlvbihldmVudF9uYW1lKSB7CiAgR01hcHMub2ZmKGV2ZW50X25hbWUsIHRoaXMpOwp9OwoKR01hcHMuY3VzdG9tX2V2ZW50cyA9IFsnbWFya2VyX2FkZGVkJywgJ21hcmtlcl9yZW1vdmVkJywgJ3BvbHlsaW5lX2FkZGVkJywgJ3BvbHlsaW5lX3JlbW92ZWQnLCAncG9seWdvbl9hZGRlZCcsICdwb2x5Z29uX3JlbW92ZWQnLCAnZ2VvbG9jYXRlZCcsICdnZW9sb2NhdGlvbl9mYWlsZWQnXTsKCkdNYXBzLm9uID0gZnVuY3Rpb24oZXZlbnRfbmFtZSwgb2JqZWN0LCBoYW5kbGVyKSB7CiAgaWYgKEdNYXBzLmN1c3RvbV9ldmVudHMuaW5kZXhPZihldmVudF9uYW1lKSA9PSAtMSkgewogICAgaWYob2JqZWN0IGluc3RhbmNlb2YgR01hcHMpIG9iamVjdCA9IG9iamVjdC5tYXA7CiAgICByZXR1cm4gZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIob2JqZWN0LCBldmVudF9uYW1lLCBoYW5kbGVyKTsKICB9CiAgZWxzZSB7CiAgICB2YXIgcmVnaXN0ZXJlZF9ldmVudCA9IHsKICAgICAgaGFuZGxlciA6IGhhbmRsZXIsCiAgICAgIGV2ZW50TmFtZSA6IGV2ZW50X25hbWUKICAgIH07CgogICAgb2JqZWN0LnJlZ2lzdGVyZWRfZXZlbnRzW2V2ZW50X25hbWVdID0gb2JqZWN0LnJlZ2lzdGVyZWRfZXZlbnRzW2V2ZW50X25hbWVdIHx8IFtdOwogICAgb2JqZWN0LnJlZ2lzdGVyZWRfZXZlbnRzW2V2ZW50X25hbWVdLnB1c2gocmVnaXN0ZXJlZF9ldmVudCk7CgogICAgcmV0dXJuIHJlZ2lzdGVyZWRfZXZlbnQ7CiAgfQp9OwoKR01hcHMub2ZmID0gZnVuY3Rpb24oZXZlbnRfbmFtZSwgb2JqZWN0KSB7CiAgaWYgKEdNYXBzLmN1c3RvbV9ldmVudHMuaW5kZXhPZihldmVudF9uYW1lKSA9PSAtMSkgewogICAgaWYob2JqZWN0IGluc3RhbmNlb2YgR01hcHMpIG9iamVjdCA9IG9iamVjdC5tYXA7CiAgICBnb29nbGUubWFwcy5ldmVudC5jbGVhckxpc3RlbmVycyhvYmplY3QsIGV2ZW50X25hbWUpOwogIH0KICBlbHNlIHsKICAgIG9iamVjdC5yZWdpc3RlcmVkX2V2ZW50c1tldmVudF9uYW1lXSA9IFtdOwogIH0KfTsKCkdNYXBzLmZpcmUgPSBmdW5jdGlvbihldmVudF9uYW1lLCBvYmplY3QsIHNjb3BlKSB7CiAgaWYgKEdNYXBzLmN1c3RvbV9ldmVudHMuaW5kZXhPZihldmVudF9uYW1lKSA9PSAtMSkgewogICAgZ29vZ2xlLm1hcHMuZXZlbnQudHJpZ2dlcihvYmplY3QsIGV2ZW50X25hbWUsIEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpLnNsaWNlKDIpKTsKICB9CiAgZWxzZSB7CiAgICBpZihldmVudF9uYW1lIGluIHNjb3BlLnJlZ2lzdGVyZWRfZXZlbnRzKSB7CiAgICAgIHZhciBmaXJpbmdfZXZlbnRzID0gc2NvcGUucmVnaXN0ZXJlZF9ldmVudHNbZXZlbnRfbmFtZV07CgogICAgICBmb3IodmFyIGkgPSAwOyBpIDwgZmlyaW5nX2V2ZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIChmdW5jdGlvbihoYW5kbGVyLCBzY29wZSwgb2JqZWN0KSB7CiAgICAgICAgICBoYW5kbGVyLmFwcGx5KHNjb3BlLCBbb2JqZWN0XSk7CiAgICAgICAgfSkoZmlyaW5nX2V2ZW50c1tpXVsnaGFuZGxlciddLCBzY29wZSwgb2JqZWN0KTsKICAgICAgfQogICAgfQogIH0KfTsKCkdNYXBzLmdlb2xvY2F0ZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgY29tcGxldGVfY2FsbGJhY2sgPSBvcHRpb25zLmFsd2F5cyB8fCBvcHRpb25zLmNvbXBsZXRlOwoKICBpZiAobmF2aWdhdG9yLmdlb2xvY2F0aW9uKSB7CiAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICAgIG9wdGlvbnMuc3VjY2Vzcyhwb3NpdGlvbik7CgogICAgICBpZiAoY29tcGxldGVfY2FsbGJhY2spIHsKICAgICAgICBjb21wbGV0ZV9jYWxsYmFjaygpOwogICAgICB9CiAgICB9LCBmdW5jdGlvbihlcnJvcikgewogICAgICBvcHRpb25zLmVycm9yKGVycm9yKTsKCiAgICAgIGlmIChjb21wbGV0ZV9jYWxsYmFjaykgewogICAgICAgIGNvbXBsZXRlX2NhbGxiYWNrKCk7CiAgICAgIH0KICAgIH0sIG9wdGlvbnMub3B0aW9ucyk7CiAgfQogIGVsc2UgewogICAgb3B0aW9ucy5ub3Rfc3VwcG9ydGVkKCk7CgogICAgaWYgKGNvbXBsZXRlX2NhbGxiYWNrKSB7CiAgICAgIGNvbXBsZXRlX2NhbGxiYWNrKCk7CiAgICB9CiAgfQp9OwoKR01hcHMuZ2VvY29kZSA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB0aGlzLmdlb2NvZGVyID0gbmV3IGdvb2dsZS5tYXBzLkdlb2NvZGVyKCk7CiAgdmFyIGNhbGxiYWNrID0gb3B0aW9ucy5jYWxsYmFjazsKICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbGF0JykgJiYgb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnbG5nJykpIHsKICAgIG9wdGlvbnMubGF0TG5nID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhvcHRpb25zLmxhdCwgb3B0aW9ucy5sbmcpOwogIH0KCiAgZGVsZXRlIG9wdGlvbnMubGF0OwogIGRlbGV0ZSBvcHRpb25zLmxuZzsKICBkZWxldGUgb3B0aW9ucy5jYWxsYmFjazsKCiAgdGhpcy5nZW9jb2Rlci5nZW9jb2RlKG9wdGlvbnMsIGZ1bmN0aW9uKHJlc3VsdHMsIHN0YXR1cykgewogICAgY2FsbGJhY2socmVzdWx0cywgc3RhdHVzKTsKICB9KTsKfTsKCmlmICh0eXBlb2Ygd2luZG93Lmdvb2dsZSA9PT0gJ29iamVjdCcgJiYgd2luZG93Lmdvb2dsZS5tYXBzKSB7CiAgLy89PT09PT09PT09PT09PT09PT09PT09PT09PQogIC8vIFBvbHlnb24gY29udGFpbnNMYXRMbmcKICAvLyBodHRwczovL2dpdGh1Yi5jb20vdHBhcmtpbi9Hb29nbGUtTWFwcy1Qb2ludC1pbi1Qb2x5Z29uCiAgLy8gUG95Z29uIGdldEJvdW5kcyBleHRlbnNpb24gLSBnb29nbGUtbWFwcy1leHRlbnNpb25zCiAgLy8gaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2dvb2dsZS1tYXBzLWV4dGVuc2lvbnMvc291cmNlL2Jyb3dzZS9nb29nbGUubWFwcy5Qb2x5Z29uLmdldEJvdW5kcy5qcwogIGlmICghZ29vZ2xlLm1hcHMuUG9seWdvbi5wcm90b3R5cGUuZ2V0Qm91bmRzKSB7CiAgICBnb29nbGUubWFwcy5Qb2x5Z29uLnByb3RvdHlwZS5nZXRCb3VuZHMgPSBmdW5jdGlvbihsYXRMbmcpIHsKICAgICAgdmFyIGJvdW5kcyA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmdCb3VuZHMoKTsKICAgICAgdmFyIHBhdGhzID0gdGhpcy5nZXRQYXRocygpOwogICAgICB2YXIgcGF0aDsKCiAgICAgIGZvciAodmFyIHAgPSAwOyBwIDwgcGF0aHMuZ2V0TGVuZ3RoKCk7IHArKykgewogICAgICAgIHBhdGggPSBwYXRocy5nZXRBdChwKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhdGguZ2V0TGVuZ3RoKCk7IGkrKykgewogICAgICAgICAgYm91bmRzLmV4dGVuZChwYXRoLmdldEF0KGkpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBib3VuZHM7CiAgICB9OwogIH0KCiAgaWYgKCFnb29nbGUubWFwcy5Qb2x5Z29uLnByb3RvdHlwZS5jb250YWluc0xhdExuZykgewogICAgLy8gUG9seWdvbiBjb250YWluc0xhdExuZyAtIG1ldGhvZCB0byBkZXRlcm1pbmUgaWYgYSBsYXRMbmcgaXMgd2l0aGluIGEgcG9seWdvbgogICAgZ29vZ2xlLm1hcHMuUG9seWdvbi5wcm90b3R5cGUuY29udGFpbnNMYXRMbmcgPSBmdW5jdGlvbihsYXRMbmcpIHsKICAgICAgLy8gRXhjbHVkZSBwb2ludHMgb3V0c2lkZSBvZiBib3VuZHMgYXMgdGhlcmUgaXMgbm8gd2F5IHRoZXkgYXJlIGluIHRoZSBwb2x5CiAgICAgIHZhciBib3VuZHMgPSB0aGlzLmdldEJvdW5kcygpOwoKICAgICAgaWYgKGJvdW5kcyAhPT0gbnVsbCAmJiAhYm91bmRzLmNvbnRhaW5zKGxhdExuZykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIFJheWNhc3QgcG9pbnQgaW4gcG9seWdvbiBtZXRob2QKICAgICAgdmFyIGluUG9seSA9IGZhbHNlOwoKICAgICAgdmFyIG51bVBhdGhzID0gdGhpcy5nZXRQYXRocygpLmdldExlbmd0aCgpOwogICAgICBmb3IgKHZhciBwID0gMDsgcCA8IG51bVBhdGhzOyBwKyspIHsKICAgICAgICB2YXIgcGF0aCA9IHRoaXMuZ2V0UGF0aHMoKS5nZXRBdChwKTsKICAgICAgICB2YXIgbnVtUG9pbnRzID0gcGF0aC5nZXRMZW5ndGgoKTsKICAgICAgICB2YXIgaiA9IG51bVBvaW50cyAtIDE7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtUG9pbnRzOyBpKyspIHsKICAgICAgICAgIHZhciB2ZXJ0ZXgxID0gcGF0aC5nZXRBdChpKTsKICAgICAgICAgIHZhciB2ZXJ0ZXgyID0gcGF0aC5nZXRBdChqKTsKCiAgICAgICAgICBpZiAodmVydGV4MS5sbmcoKSA8IGxhdExuZy5sbmcoKSAmJiB2ZXJ0ZXgyLmxuZygpID49IGxhdExuZy5sbmcoKSB8fCB2ZXJ0ZXgyLmxuZygpIDwgbGF0TG5nLmxuZygpICYmIHZlcnRleDEubG5nKCkgPj0gbGF0TG5nLmxuZygpKSB7CiAgICAgICAgICAgIGlmICh2ZXJ0ZXgxLmxhdCgpICsgKGxhdExuZy5sbmcoKSAtIHZlcnRleDEubG5nKCkpIC8gKHZlcnRleDIubG5nKCkgLSB2ZXJ0ZXgxLmxuZygpKSAqICh2ZXJ0ZXgyLmxhdCgpIC0gdmVydGV4MS5sYXQoKSkgPCBsYXRMbmcubGF0KCkpIHsKICAgICAgICAgICAgICBpblBvbHkgPSAhaW5Qb2x5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgaiA9IGk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gaW5Qb2x5OwogICAgfTsKICB9CgogIGlmICghZ29vZ2xlLm1hcHMuQ2lyY2xlLnByb3RvdHlwZS5jb250YWluc0xhdExuZykgewogICAgZ29vZ2xlLm1hcHMuQ2lyY2xlLnByb3RvdHlwZS5jb250YWluc0xhdExuZyA9IGZ1bmN0aW9uKGxhdExuZykgewogICAgICBpZiAoZ29vZ2xlLm1hcHMuZ2VvbWV0cnkpIHsKICAgICAgICByZXR1cm4gZ29vZ2xlLm1hcHMuZ2VvbWV0cnkuc3BoZXJpY2FsLmNvbXB1dGVEaXN0YW5jZUJldHdlZW4odGhpcy5nZXRDZW50ZXIoKSwgbGF0TG5nKSA8PSB0aGlzLmdldFJhZGl1cygpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9OwogIH0KCiAgZ29vZ2xlLm1hcHMuTGF0TG5nQm91bmRzLnByb3RvdHlwZS5jb250YWluc0xhdExuZyA9IGZ1bmN0aW9uKGxhdExuZykgewogICAgcmV0dXJuIHRoaXMuY29udGFpbnMobGF0TG5nKTsKICB9OwoKICBnb29nbGUubWFwcy5NYXJrZXIucHJvdG90eXBlLnNldEZlbmNlcyA9IGZ1bmN0aW9uKGZlbmNlcykgewogICAgdGhpcy5mZW5jZXMgPSBmZW5jZXM7CiAgfTsKCiAgZ29vZ2xlLm1hcHMuTWFya2VyLnByb3RvdHlwZS5hZGRGZW5jZSA9IGZ1bmN0aW9uKGZlbmNlKSB7CiAgICB0aGlzLmZlbmNlcy5wdXNoKGZlbmNlKTsKICB9OwoKICBnb29nbGUubWFwcy5NYXJrZXIucHJvdG90eXBlLmdldElkID0gZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpc1snX19nbV9pZCddOwogIH07Cn0KCi8vPT09PT09PT09PT09PT09PT09PT09PT09PT0KLy8gQXJyYXkgaW5kZXhPZgovLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L2luZGV4T2YKaWYgKCFBcnJheS5wcm90b3R5cGUuaW5kZXhPZikgewogIEFycmF5LnByb3RvdHlwZS5pbmRleE9mID0gZnVuY3Rpb24gKHNlYXJjaEVsZW1lbnQgLyosIGZyb21JbmRleCAqLyApIHsKICAgICAgInVzZSBzdHJpY3QiOwogICAgICBpZiAodGhpcyA9PSBudWxsKSB7CiAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAgICAgIH0KICAgICAgdmFyIHQgPSBPYmplY3QodGhpcyk7CiAgICAgIHZhciBsZW4gPSB0Lmxlbmd0aCA+Pj4gMDsKICAgICAgaWYgKGxlbiA9PT0gMCkgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHZhciBuID0gMDsKICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7CiAgICAgICAgICBuID0gTnVtYmVyKGFyZ3VtZW50c1sxXSk7CiAgICAgICAgICBpZiAobiAhPSBuKSB7IC8vIHNob3J0Y3V0IGZvciB2ZXJpZnlpbmcgaWYgaXQncyBOYU4KICAgICAgICAgICAgICBuID0gMDsKICAgICAgICAgIH0gZWxzZSBpZiAobiAhPSAwICYmIG4gIT0gSW5maW5pdHkgJiYgbiAhPSAtSW5maW5pdHkpIHsKICAgICAgICAgICAgICBuID0gKG4gPiAwIHx8IC0xKSAqIE1hdGguZmxvb3IoTWF0aC5hYnMobikpOwogICAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChuID49IGxlbikgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICB9CiAgICAgIHZhciBrID0gbiA+PSAwID8gbiA6IE1hdGgubWF4KGxlbiAtIE1hdGguYWJzKG4pLCAwKTsKICAgICAgZm9yICg7IGsgPCBsZW47IGsrKykgewogICAgICAgICAgaWYgKGsgaW4gdCAmJiB0W2tdID09PSBzZWFyY2hFbGVtZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGs7CiAgICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIC0xOwogIH0KfQoKcmV0dXJuIEdNYXBzOwp9KSk7Cg=="></script>
	<script type="text/javascript">
		var map;
		var ruta=[];
		$(document).ready(function() {
		 	document.getElementById("comunidad").addEventListener("change", ObtenerProvincias);
		 	 map = new GMaps({
		 	  div: '#map',
		 	  lat: -12.043333,
		 	  lng: -77.028333
		 	});
		 	//dibujar ruta
		 	//con esto obtengo las coordenadas y coloco el marker
		 	google.maps.event.addListener(map, 'click', function(event) {
		 	 
		 	        var coordenadas = event.latLng;
		 	        var lat = coordenadas.lat();
		 	        var lng = coordenadas.lng();
		 	        console.log("lat"+ lat);
		 	            placeMarker(event.latLng);
		 	 
		 	});
		 	 
		 	 
		 	//y aqu la funcin que me permite colocar el marcador, los condicionales son
		 	//para que solo un marcador aparezca a la vez, as que si ya existe uno, lo recoloca
		 	//en la nueva posicin
		 	 
		 	var marker;
		 	 
		 	function placeMarker(location) {
		 	  if ( marker ) {
		 	    marker.setPosition(location);
		 	  } else {
		 	    marker = new google.maps.Marker({
		 	      position: location,
		 	      map: map
		 	    });
		 	  }
		 	} //fin funcion placeMarker
		});

		 function ObtenerProvincias() {
		 	var comunidad = $("#comunidad").val();
		 	var params = {
				"comunidad": comunidad, 
				"funcion": "obtenerProvincias"
			};
		 	$.ajax({
		 		url: './funciones.php',//direccion donde esta el web service
		 		type: 'POST', //metpdp que se va a utilizar para el envio de datos
		 		//data:'base='+base+'&altura='+altura , //variables que quiero pasar al webservice
		 		//data: 'comunidad='+comunidad , //variables que quiero pasar al webservice
		 		data: params,
		 		//beforeSend: function() {
		 		//	$("esperar".html("Procesando, espere por favor"));
		 		//},
		 		dataType: 'json', //formato de los datos que va a devolver el websrvice
		 		success:function(data, textStatus,jqxhr){
		 			//data:datos que devuelve
		 			//jqxhr: informacion de la peticion
		 			//textStatus:informacion del estado
		 			var texto="";
		 			texto = "Provincias: <select type='text' id='provincia' >";
		 			texto= texto +  "<option value='0'>-------------</option>";
		 			console.log(data);
		 			//alert(JSON.stringify(data)); //convierte el JSON a string que es lo que necesita el alert
		 			//var array = JSON.parse(data);
		 			for (var i in data) {
		 			//for (var i=0; i<data.length;i++){
		 			
		 				
		 				texto= texto + "<option value='" + data[i].id +"' >" +data[i]['provincia'] +"</option>";
		 			}
		 			$('#div_provincias').html(texto);
		 			$('#div_ciudades').css("display", "none");
		 			document.getElementById("provincia").addEventListener("change", ObtenerCiudades);
		 		},
		 		error:function(jqxhr, textStatus, errorMessage){
		 			alert(textStatus+ "" +errorMessage);
		 		}
		 	});
		 }

		
		 	function ObtenerCiudades() {
		 		var provincia = $("#provincia").val();
		 		var params = {
				"provincia": provincia, 
				"funcion": "obtenerCiudades"
				};
		 		$.ajax({
		 			url: './funciones.php',//direccion donde esta el web service
		 			type: 'POST', //metpdp que se va a utilizar para el envio de datos
		 			//data:'base='+base+'&altura='+altura , //variables que quiero pasar al webservice
		 			//data: 'provincia='+provincia , //variables que quiero pasar al webservice
		 			data: params,
		 			beforeSend: function() {
		 				$("esperando").html("Procesando, espere por favor");
		 				//$("esperando").spin({radius:3,width:2, height:2, length:4});
		 			},
		 			dataType: 'json', //formato de los datos que va a devolver el websrvice
		 			success:function(data, textStatus,jqxhr){
		 				console.log("AAAA");
		 				var texto="";
			 			texto = "Ciudades: <select type='text' id='ciudad' >";
			 			texto= texto +  "<option value='0'>-------------</option>";
			 			console.log("Ciudades" +data);
			 			for (var i in data) {

			 				texto= texto + "<option value='" + data[i].id +"' >" +data[i]['municipio'] +"</option>";
			 			}
			 			console.log("TExto" +texto);
		 				$('#div_ciudades').html(texto);
		 				$('#div_ciudades').css("display", "block");
		 				document.getElementById("ciudad").addEventListener("change", municipioSeleccionado);
		 			},
		 			error:function(jqxhr, estado, errorMessage){
		 				alert(textStatus+ "" +errorMessage);
		 				console.log(estado);
		 				console.log(errorMessage);
		 			},
		 			//este codigo 'complete' se ejecuta despues del success
		 			//o despues del error
		 			complete: function(jqxhr, estado) {
		 				//el estado puede ser: success, notmodified,
		 				//timeout, error, abort, parseerror
		 				console.log(estado);
		 			},
		 			//la peticion espera la respuesta cada x milisegungos
		 			//si pasa ese tiempo saldra por error
		 			 timeout:10000
		 		});
		
				
		 }
		 function municipioSeleccionado(){
		 	var idMunicipio = $("#ciudad").val();

		 	var parametros = {
		 			"funcion":"obtenerMunicipio",
		 			"idMunicipio":idMunicipio
		 		}
		 	$.ajax({
		 		url: './funciones.php', //direccin donde se encuentra el webservice
		 		type: 'POST', //mtodo que se va a utilizar para el envo de los datos
		 		data: parametros, //variables que quiero pasar al webservice
		 		dataType: 'json', //formato de los datos que va a devolver el webservice
		 		success: function(data, textStatus, jqxhr){
		 			//map.setCenter(data['latitud'],data['longitud']);
		 			var latlng = new google.maps.LatLng(data['latitud'],data['longitud']);
		 			map.panTo(latlng);
		 			map.setZoom(9);
		 			map.addMarker({
		 			  lat: data['latitud'],
		 			  lng: data['longitud'],
		 			  title: data['municipio'],
		 			  click: function(e) {
		 			    alert('Ests visitando '+ data['municipio']);
		 			  }
		 			});
		 			
		 			// map.addControl({
		 			//   position: 'top_right',
		 			//   content: 'Geolocate',
		 			//   style: {
		 			//     margin: '5px',
		 			//     padding: '1px 6px',
		 			//     border: 'solid 1px #717B87',
		 			//     background: '#fff'
		 			//   },
		 			//   events: {
		 			//     click: function(){
		 			//       console.log(this);
		 			//     }
		 			//   }
		 			// });
		 		},
		 		error: function (jqxhr, textStatus, errorMessage){
		 			alert(textStatus+" "+errorMessage);
		 		}
		 	});
		 } 


	</script>	 
</head>
<body>
	<form id ="form_id">
		Comunidades: <select type="text" id="comunidad" >
	<?php
		include_once './conexion.php';
		include './funciones.php';
		
		//hago la consulta
		$consulta = "select * from comunidades";
		$conexion = conectar();
		$resultado= $conexion->query($consulta);
		
		echo "<option value='0'>--------</option>";
			while ($fila = $resultado->fetch_assoc()) {
				
				echo "<option value='".$fila['id']."' >".utf8_encode($fila['comunidad'])."</option>";
			}
		 
		
	?>
	
	</select>
	<div id='div_provincias'></div>
	<div id='div_ciudades'></div>
	<div id='esperando'></div>
	
	</form>
	<div id='map' style="height:400px;width:700px;margin-top:40px"></div>
</body>
</html>